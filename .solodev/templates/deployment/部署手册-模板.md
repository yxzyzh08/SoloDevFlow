# 部署手册

> **项目**: [项目名称]
> **版本**: [版本号]
> **迭代**: Iteration X
> **日期**: YYYY-MM-DD

---

## 一、部署准备

### 1.1 获取部署代码

**从Git仓库获取**：
```bash
git clone [repository-url]
cd [project-name]
git checkout [version-tag]  # 如 v1.0.0
```

**验证代码版本**：
```bash
git log -1
# 确认commit hash和tag正确
```

### 1.2 环境变量配置

**创建环境变量文件**：
```bash
cp .env.example .env.production
```

**编辑环境变量**：
```bash
# .env.production
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
REDIS_URL=redis://localhost:6379
JWT_SECRET=[生成随机字符串]
# ... 其他配置
```

**验证环境变量**：
```bash
# 检查环境变量文件语法
node -e "require('dotenv').config({path:'.env.production'}); console.log('✓ 环境变量加载成功')"
```

---

## 二、开发环境部署

### 2.1 适用场景

- 本地开发测试
- 快速验证功能
- 调试问题

### 2.2 部署步骤

#### 步骤1：安装依赖

```bash
npm install
# 或
yarn install
```

**验证**：
```bash
npm list --depth=0
# 确认所有依赖已安装
```

---

#### 步骤2：启动本地数据库

**选项A：使用Docker**（推荐）
```bash
docker run -d \
  --name dev-postgres \
  -e POSTGRES_USER=devuser \
  -e POSTGRES_PASSWORD=devpass \
  -e POSTGRES_DB=devdb \
  -p 5432:5432 \
  postgres:14
```

**选项B：使用SQLite**
```bash
# 无需启动，直接使用文件数据库
# 在.env.development中配置
DATABASE_URL=sqlite:./dev.db
```

**验证数据库**：
```bash
# PostgreSQL
psql -h localhost -U devuser -d devdb -c "SELECT version();"

# SQLite
sqlite3 dev.db "SELECT sqlite_version();"
```

---

#### 步骤3：执行数据库迁移

```bash
npm run migrate
# 或
npx prisma migrate deploy
# 或自定义迁移脚本
```

**验证迁移**：
```bash
npm run migrate:status
# 确认所有迁移已执行
```

---

#### 步骤4：（可选）填充种子数据

```bash
npm run seed
```

---

#### 步骤5：启动开发服务器

```bash
npm run dev
```

**验证服务**：
```bash
curl http://localhost:3000/health
# 期望：{"status":"healthy"}
```

---

### 2.3 开发环境快速重置

**清理并重新部署**：
```bash
# 停止服务
Ctrl+C

# 删除数据库容器
docker rm -f dev-postgres

# 重新执行步骤2-5
```

---

## 三、测试环境部署

### 3.1 适用场景

- 集成测试
- 性能测试
- 用户验收测试（UAT）

### 3.2 服务器准备

**登录测试服务器**：
```bash
ssh user@test-server.example.com
```

**安装基础软件**：
```bash
# 更新包管理器
sudo apt update

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 安装Docker（如使用）
curl -fsSL https://get.docker.com | sudo sh

# 安装Nginx
sudo apt install -y nginx
```

**验证安装**：
```bash
node -v  # 期望：v18.x.x
docker -v  # 期望：Docker version x.x.x
nginx -v  # 期望：nginx version x.x.x
```

---

### 3.3 部署步骤

#### 步骤1：创建部署目录

```bash
sudo mkdir -p /var/www/[project-name]
sudo chown $USER:$USER /var/www/[project-name]
cd /var/www/[project-name]
```

---

#### 步骤2：部署代码

**克隆代码**：
```bash
git clone [repository-url] .
git checkout [version-tag]
```

**安装生产依赖**：
```bash
npm ci --production
```

**构建项目**（如需要）：
```bash
npm run build
```

---

#### 步骤3：部署PostgreSQL数据库

**使用Docker部署**：
```bash
docker run -d \
  --name test-postgres \
  --restart unless-stopped \
  -e POSTGRES_USER=${DB_USER} \
  -e POSTGRES_PASSWORD=${DB_PASSWORD} \
  -e POSTGRES_DB=${DB_NAME} \
  -v /var/lib/postgresql/data:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:14
```

**验证数据库**：
```bash
docker exec -it test-postgres psql -U ${DB_USER} -d ${DB_NAME} -c "SELECT version();"
```

---

#### 步骤4：部署Redis缓存

```bash
docker run -d \
  --name test-redis \
  --restart unless-stopped \
  -v /var/lib/redis/data:/data \
  -p 6379:6379 \
  redis:6 redis-server --appendonly yes
```

**验证Redis**：
```bash
docker exec -it test-redis redis-cli ping
# 期望：PONG
```

---

#### 步骤5：配置环境变量

```bash
# 创建.env.production文件
cat > .env.production <<EOF
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@localhost:5432/${DB_NAME}
REDIS_URL=redis://localhost:6379
JWT_SECRET=$(openssl rand -base64 32)
# ... 其他配置
EOF
```

---

#### 步骤6：执行数据库迁移

```bash
npm run migrate:prod
# 或
NODE_ENV=production npm run migrate
```

**验证迁移**：
```bash
npm run migrate:status
```

---

#### 步骤7：使用PM2启动服务

**安装PM2**：
```bash
sudo npm install -g pm2
```

**创建PM2配置文件**：
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: '[app-name]',
    script: './dist/index.js',  // 或 './src/index.js'
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production'
    },
    error_file: './logs/error.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    max_memory_restart: '500M'
  }]
};
```

**启动服务**：
```bash
pm2 start ecosystem.config.js
```

**验证服务**：
```bash
pm2 list
curl http://localhost:3000/health
```

**设置PM2开机自启**：
```bash
pm2 startup
pm2 save
```

---

#### 步骤8：配置Nginx反向代理

**创建Nginx配置**：
```nginx
# /etc/nginx/sites-available/[project-name]
server {
    listen 80;
    server_name test.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**启用站点**：
```bash
sudo ln -s /etc/nginx/sites-available/[project-name] /etc/nginx/sites-enabled/
sudo nginx -t  # 验证配置
sudo systemctl reload nginx
```

---

#### 步骤9：配置HTTPS（使用Let's Encrypt）

```bash
# 安装certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d test.example.com

# 验证自动续期
sudo certbot renew --dry-run
```

---

#### 步骤10：验证部署

**健康检查**：
```bash
curl https://test.example.com/health
```

**运行冒烟测试**：
```bash
npm run test:smoke
```

---

### 3.4 测试环境部署验证清单

- [ ] 服务启动成功（pm2 list显示online）
- [ ] 健康检查通过（/health返回200）
- [ ] Nginx反向代理工作正常
- [ ] HTTPS证书有效
- [ ] 数据库连接正常
- [ ] Redis连接正常
- [ ] 冒烟测试通过
- [ ] 日志正常输出

---

## 四、生产环境部署

### 4.1 适用场景

- 正式上线
- 为真实用户提供服务

### 4.2 部署前检查清单

**代码准备**：
- [ ] 所有测试通过（E2E、性能、混沌）
- [ ] 代码已合并到main分支
- [ ] Git tag已创建（如v1.0.0）
- [ ] 构建产物已验证

**基础设施准备**：
- [ ] 生产服务器已准备
- [ ] 数据库已部署（或备份完成）
- [ ] 域名DNS已配置
- [ ] SSL证书已准备

**备份准备**：
- [ ] 当前数据库已备份
- [ ] 当前代码已备份
- [ ] 回滚方案已准备

**通知准备**（如需维护窗口）：
- [ ] 用户已通知
- [ ] 团队已通知

---

### 4.3 部署步骤

#### 部署前备份

**备份数据库**：
```bash
# PostgreSQL
pg_dump -h localhost -U ${DB_USER} ${DB_NAME} > backup_$(date +%Y%m%d_%H%M%S).sql

# 或使用Docker
docker exec prod-postgres pg_dump -U ${DB_USER} ${DB_NAME} > backup_$(date +%Y%m%d_%H%M%S).sql
```

**备份当前代码**：
```bash
cd /var/www/[project-name]
tar -czf ../backup_code_$(date +%Y%m%d_%H%M%S).tar.gz .
```

---

#### 部署新版本

**选项A：停机部署（Downtime Deployment）**

```bash
# 1. 停止当前服务
pm2 stop [app-name]

# 2. 拉取新代码
git fetch --all
git checkout [version-tag]

# 3. 安装依赖
npm ci --production

# 4. 构建
npm run build

# 5. 执行数据库迁移
npm run migrate:prod

# 6. 重启服务
pm2 restart [app-name]

# 7. 验证
curl http://localhost:3000/health
```

**停机时间**：约5-10分钟

---

**选项B：蓝绿部署（Blue-Green Deployment）**

```bash
# 1. 在新目录部署新版本（绿环境）
mkdir -p /var/www/[project-name]-green
cd /var/www/[project-name]-green
git clone [repository-url] .
git checkout [version-tag]
npm ci --production
npm run build

# 2. 配置新版本环境变量（复制并修改PORT）
cp /var/www/[project-name]/.env.production .env.production
# 修改 PORT=3001

# 3. 启动新版本（监听3001端口）
pm2 start ecosystem.config.js --name [app-name]-green

# 4. 验证新版本
curl http://localhost:3001/health

# 5. Nginx切换流量到新版本
# 修改Nginx配置：proxy_pass http://localhost:3001
sudo vim /etc/nginx/sites-available/[project-name]
sudo nginx -t
sudo systemctl reload nginx

# 6. 验证生产流量
curl https://example.com/health

# 7. 停止旧版本
pm2 stop [app-name]

# 8. 清理旧版本（可选，保留一段时间以便回滚）
# rm -rf /var/www/[project-name]
```

**停机时间**：0（无停机部署）

---

**选项C：滚动更新（Rolling Update）- 适用于多实例**

```bash
# 假设有3个实例：instance-0, instance-1, instance-2

# 1. 停止instance-0
pm2 stop instance-0

# 2. 更新instance-0代码
cd /var/www/instance-0
git fetch && git checkout [version-tag]
npm ci --production && npm run build

# 3. 重启instance-0
pm2 restart instance-0

# 4. 验证instance-0健康
curl http://localhost:3000/health

# 5. 重复步骤1-4更新instance-1和instance-2
# ...
```

**停机时间**：0（始终有实例在运行）

---

#### 数据库迁移注意事项

**兼容性迁移**（推荐）：
```bash
# 确保迁移向后兼容，允许新旧代码共存
# 例如：添加新字段时设置默认值
npm run migrate:prod
```

**破坏性迁移**（需停机）：
```bash
# 如果迁移不兼容旧代码，必须先停止所有服务
pm2 stop all
npm run migrate:prod
pm2 start all
```

---

#### 部署后验证

**健康检查**：
```bash
curl https://example.com/health
# 期望：{"status":"healthy","version":"1.0.0"}
```

**冒烟测试**：
```bash
# 在本地运行针对生产环境的冒烟测试
TEST_ENV=production npm run test:smoke
```

**监控检查**：
```bash
# 查看PM2状态
pm2 list

# 查看日志（检查是否有错误）
pm2 logs [app-name] --lines 50

# 查看资源使用
pm2 monit
```

**业务功能验证**：
- [ ] 用户可以登录
- [ ] 核心功能正常
- [ ] 关键API响应正常

---

### 4.4 生产环境部署验证清单

- [ ] 服务启动成功（所有实例online）
- [ ] 健康检查通过
- [ ] HTTPS证书有效
- [ ] 冒烟测试通过
- [ ] 数据库迁移成功
- [ ] 日志无严重错误
- [ ] 监控指标正常：
  - [ ] 响应时间 < 500ms
  - [ ] 错误率 < 1%
  - [ ] CPU使用率 < 70%
  - [ ] 内存使用率 < 70%

---

## 五、回滚操作

### 5.1 快速回滚（代码回滚）

```bash
# 1. 停止当前版本
pm2 stop [app-name]

# 2. 回滚代码到上一个版本
git checkout [previous-version-tag]
npm ci --production
npm run build

# 3. 重启服务
pm2 restart [app-name]

# 4. 验证
curl https://example.com/health
```

**回滚时间**：< 5分钟

---

### 5.2 完整回滚（包含数据库）

```bash
# 1. 停止服务
pm2 stop [app-name]

# 2. 恢复数据库备份
psql -h localhost -U ${DB_USER} ${DB_NAME} < backup_YYYYMMDD_HHMMSS.sql

# 3. 回滚代码
git checkout [previous-version-tag]
npm ci --production
npm run build

# 4. 重启服务
pm2 restart [app-name]

# 5. 验证
curl https://example.com/health
```

**回滚时间**：取决于数据库大小，通常 < 10分钟

---

### 5.3 蓝绿部署回滚

```bash
# 1. Nginx切回旧版本
# 修改Nginx配置：proxy_pass http://localhost:3000（旧版本端口）
sudo vim /etc/nginx/sites-available/[project-name]
sudo nginx -t
sudo systemctl reload nginx

# 2. 验证
curl https://example.com/health

# 3. 停止新版本
pm2 stop [app-name]-green
```

**回滚时间**：< 1分钟（几乎瞬间）

---

## 六、Docker部署（可选）

### 6.1 构建Docker镜像

**Dockerfile示例**：
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["node", "dist/index.js"]
```

**构建镜像**：
```bash
docker build -t [project-name]:v1.0.0 .
```

---

### 6.2 使用Docker Compose部署

**docker-compose.yml示例**：
```yaml
version: '3.8'

services:
  app:
    image: [project-name]:v1.0.0
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@db:5432/dbname
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    restart: unless-stopped

  db:
    image: postgres:14
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=dbname
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:6
    volumes:
      - redis-data:/data
    restart: unless-stopped

volumes:
  postgres-data:
  redis-data:
```

**启动服务**：
```bash
docker-compose up -d
```

**查看日志**：
```bash
docker-compose logs -f app
```

---

## 七、常见问题排查

### 7.1 服务无法启动

**检查日志**：
```bash
pm2 logs [app-name] --err
# 或
docker logs [container-name]
```

**可能原因**：
- 环境变量配置错误 → 检查.env文件
- 端口被占用 → `lsof -i :3000` 查找占用进程
- 依赖未安装 → 重新执行 `npm ci`

---

### 7.2 数据库连接失败

**验证数据库可访问**：
```bash
psql -h localhost -U ${DB_USER} -d ${DB_NAME}
```

**可能原因**：
- DATABASE_URL配置错误
- 数据库服务未启动 → `docker ps` 或 `systemctl status postgresql`
- 防火墙阻止连接 → 检查iptables规则

---

### 7.3 部署后性能下降

**检查资源使用**：
```bash
pm2 monit
htop
```

**可能原因**：
- 内存泄漏 → 检查应用代码
- 数据库索引缺失 → 执行EXPLAIN分析慢查询
- 缓存未启用 → 验证Redis连接

---

## 八、部署最佳实践

### 8.1 版本管理

- [ ] 使用语义化版本（Semantic Versioning）
- [ ] 每次部署创建Git tag
- [ ] 保留最近3个版本的备份

### 8.2 安全实践

- [ ] 不在Git中提交.env文件
- [ ] 使用强密码和密钥
- [ ] 定期更新依赖包（npm audit fix）
- [ ] 配置防火墙（只开放必要端口）

### 8.3 监控实践

- [ ] 配置应用性能监控（APM）
- [ ] 配置日志聚合（ELK / Loki）
- [ ] 配置告警（Prometheus Alertmanager）
- [ ] 配置正常运行时间监控（UptimeRobot / Pingdom）

---

## 九、参考资料

**相关文档**：
- 运维手册.md - 日常运维操作
- CICD配置说明.md - 自动化部署配置
- 架构文档 - 系统架构说明

**外部资源**：
- PM2文档: https://pm2.keymetrics.io/
- Docker文档: https://docs.docker.com/
- Nginx文档: https://nginx.org/en/docs/

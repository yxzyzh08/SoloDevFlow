# 性能测试方案

> **项目**: [项目名称]
> **版本**: [版本号]
> **迭代**: Iteration X
> **日期**: YYYY-MM-DD

---

## 一、性能测试概述

### 1.1 测试目标

[描述性能测试的目标，如：验证系统在目标负载下的响应时间、吞吐量和资源使用情况]

### 1.2 性能指标定义

| 指标名称         | 定义                                   | 单位       |
| ---------------- | -------------------------------------- | ---------- |
| **响应时间**     | 从发送请求到收到完整响应的时间         | ms         |
| **吞吐量**       | 单位时间内系统处理的请求数             | req/s      |
| **并发用户数**   | 同时访问系统的用户数                   | 用户数     |
| **错误率**       | 失败请求数 / 总请求数                  | %          |
| **CPU使用率**    | 服务器CPU使用百分比                    | %          |
| **内存使用率**   | 服务器内存使用百分比                   | %          |
| **数据库连接数** | 数据库活跃连接数                       | 连接数     |

### 1.3 性能目标

> 基于PRD中的非功能性需求

| 场景               | 响应时间目标 | 吞吐量目标  | 并发数     | 错误率目标 |
| ------------------ | ------------ | ----------- | ---------- | ---------- |
| [场景1]            | < 200ms      | >= 100 req/s| 50         | < 1%       |
| [场景2]            | < 500ms      | >= 50 req/s | 100        | < 1%       |
| [场景3]            | < 1000ms     | >= 20 req/s | 200        | < 1%       |

### 1.4 测试工具

- **负载生成工具**：[如 Apache JMeter / k6 / Artillery]
- **监控工具**：[如 Prometheus + Grafana / New Relic]
- **分析工具**：[如 性能分析报告生成器]

---

## 二、性能测试场景

### 2.1 基准性能测试（Baseline Test）

**测试目的**：建立系统性能基准线

**测试配置**：
- 并发用户数：10
- 持续时间：5分钟
- 请求间隔：恒定（无思考时间）

**测试场景**：

#### PT-001：单接口基准测试 - [接口名称]

**接口**：`GET /api/[endpoint]`

**请求参数**：
```json
{
  "param1": "value1"
}
```

**负载配置**：
```javascript
{
  vus: 10,              // 10个虚拟用户
  duration: '5m',       // 持续5分钟
  thresholds: {
    http_req_duration: ['p(95)<200'],  // 95%请求 < 200ms
    http_req_failed: ['rate<0.01']     // 错误率 < 1%
  }
}
```

**性能目标**：
- P50响应时间：< 100ms
- P95响应时间：< 200ms
- P99响应时间：< 500ms
- 吞吐量：>= 100 req/s
- 错误率：< 1%

**监控指标**：
- CPU使用率：< 50%
- 内存使用率：< 60%
- 数据库连接数：< 20

---

### 2.2 负载测试（Load Test）

**测试目的**：验证系统在预期负载下的性能表现

**测试配置**：
- 并发用户数：[根据PRD定义]
- 持续时间：10分钟
- 负载模式：恒定负载

**测试场景**：

#### PT-101：正常业务流程负载测试

**业务流程**：[如：用户登录 → 查询商品 → 创建订单]

**测试步骤**：
```
步骤1: 用户登录
  → POST /api/login
  → 获取token

步骤2: 查询商品列表
  → GET /api/products (Authorization: Bearer {token})

步骤3: 创建订单
  → POST /api/orders (Authorization: Bearer {token})
```

**负载配置**：
```javascript
{
  stages: [
    { duration: '2m', target: 50 },   // 2分钟爬坡到50用户
    { duration: '10m', target: 50 },  // 保持50用户10分钟
    { duration: '2m', target: 0 }     // 2分钟降到0
  ],
  thresholds: {
    'http_req_duration{scenario:load_test}': ['p(95)<500'],
    'http_req_failed': ['rate<0.01']
  }
}
```

**性能目标**：
- 端到端响应时间（P95）：< 500ms
- 每个步骤响应时间：见基准测试目标
- 吞吐量：>= [X] transactions/s
- 错误率：< 1%

**监控指标**：
- CPU使用率：< 70%
- 内存使用率：< 70%
- 数据库连接数：< 50
- 网络带宽：< 80%

---

### 2.3 压力测试（Stress Test）

**测试目的**：找到系统的性能极限和瓶颈

**测试配置**：
- 并发用户数：逐步递增直到系统失败
- 持续时间：每个阶段5分钟

**测试场景**：

#### PT-201：系统压力极限测试

**负载配置**：
```javascript
{
  stages: [
    { duration: '5m', target: 100 },   // 5分钟到100用户
    { duration: '5m', target: 200 },   // 5分钟到200用户
    { duration: '5m', target: 300 },   // 5分钟到300用户
    { duration: '5m', target: 400 },   // 继续递增...
    { duration: '5m', target: 0 }      // 降到0观察恢复
  ],
  thresholds: {
    'http_req_duration': ['p(95)<2000'],
    'http_req_failed': ['rate<0.05']   // 容忍5%错误率
  }
}
```

**测试目标**：
- 找到系统开始出现性能下降的临界点
- 找到系统开始出现错误的临界点
- 验证系统在压力下的稳定性
- 验证系统从高压力状态恢复的能力

**观察点**：
- 响应时间何时开始线性增长
- 错误率何时开始上升
- 资源使用率何时达到瓶颈（CPU/内存/数据库连接）
- 是否出现内存泄漏

---

### 2.4 峰值测试（Spike Test）

**测试目的**：验证系统应对突发流量的能力

**测试配置**：
- 突发峰值：从10用户瞬间增加到200用户
- 峰值持续时间：2分钟

**测试场景**：

#### PT-301：突发流量测试

**负载配置**：
```javascript
{
  stages: [
    { duration: '2m', target: 10 },    // 基线负载
    { duration: '30s', target: 200 },  // 瞬间峰值
    { duration: '2m', target: 200 },   // 保持峰值
    { duration: '30s', target: 10 },   // 快速降低
    { duration: '2m', target: 10 }     // 恢复基线
  ]
}
```

**性能目标**：
- 峰值期间错误率：< 5%
- 峰值期间P95响应时间：< 2000ms
- 峰值后恢复时间：< 30s
- 无系统崩溃或服务不可用

---

### 2.5 耐久性测试（Soak Test）

**测试目的**：验证系统长时间运行的稳定性（检测内存泄漏、资源泄漏）

**测试配置**：
- 并发用户数：50（中等负载）
- 持续时间：[2小时 / 4小时 / 24小时]

**测试场景**：

#### PT-401：长时间稳定性测试

**负载配置**：
```javascript
{
  stages: [
    { duration: '5m', target: 50 },     // 爬坡
    { duration: '2h', target: 50 },     // 持续2小时
    { duration: '5m', target: 0 }       // 降负载
  ],
  thresholds: {
    'http_req_duration': ['p(95)<500'],
    'http_req_failed': ['rate<0.01']
  }
}
```

**性能目标**：
- 响应时间无明显上升趋势
- 错误率保持稳定 < 1%
- 吞吐量保持稳定
- 资源使用率保持稳定（无持续上升）

**监控重点**：
- 内存使用趋势（每10分钟记录）
- 数据库连接数趋势
- 响应时间趋势
- 日志中的异常错误

---

## 三、数据库性能测试

### 3.1 数据库查询性能测试

**测试目的**：验证数据库查询性能

**测试场景**：

#### PT-501：复杂查询性能测试

**查询描述**：[描述复杂查询场景，如多表JOIN、聚合查询]

**测试数据量**：
- 表1：[X]条记录
- 表2：[Y]条记录
- 查询条件：[描述]

**性能目标**：
- 查询响应时间：< [Xms]
- 并发10个查询时响应时间：< [Yms]

---

### 3.2 数据库写入性能测试

**测试目的**：验证数据库写入性能和事务处理能力

**测试场景**：

#### PT-502：批量写入性能测试

**写入操作**：[描述写入操作，如批量插入订单]

**负载配置**：
- 并发写入数：20
- 每次写入记录数：100
- 持续时间：5分钟

**性能目标**：
- 单次批量写入时间：< [Xms]
- 写入吞吐量：>= [Y] records/s
- 无死锁发生

---

## 四、API性能测试矩阵

| API接口              | 并发数 | P95目标  | 吞吐量目标   | 测试用例ID |
| -------------------- | ------ | -------- | ------------ | ---------- |
| POST /api/login      | 50     | < 200ms  | >= 100 req/s | PT-001     |
| GET /api/products    | 100    | < 300ms  | >= 200 req/s | PT-002     |
| POST /api/orders     | 50     | < 500ms  | >= 50 req/s  | PT-003     |
| GET /api/orders/:id  | 100    | < 200ms  | >= 150 req/s | PT-004     |

---

## 五、性能测试执行计划

### 5.1 测试执行顺序

```
阶段1: 基准性能测试（PT-001系列）
  ↓ 建立基准线
阶段2: 负载测试（PT-101系列）
  ↓ 验证正常负载性能
阶段3: 压力测试（PT-201系列）
  ↓ 找到性能瓶颈
阶段4: 峰值测试（PT-301系列）
  ↓ 验证突发流量处理
阶段5: 耐久性测试（PT-401系列）
  ↓ 验证长期稳定性
生成性能测试报告
```

### 5.2 测试数据准备

**数据库初始数据量**：
- 用户表：[X]条
- 商品表：[Y]条
- 订单表：[Z]条

**测试数据生成脚本**：
- 路径：`test/fixtures/performance/seed-data.js`
- 执行方式：测试前自动执行

---

## 六、性能测试代码映射

> 性能测试脚本由AI在实现阶段生成

| 测试用例ID | 测试脚本文件                          | 状态     |
| ---------- | ------------------------------------- | -------- |
| PT-001     | test/performance/baseline-api.perf.js | 待生成   |
| PT-101     | test/performance/load-workflow.perf.js| 待生成   |
| PT-201     | test/performance/stress.perf.js       | 待生成   |
| PT-301     | test/performance/spike.perf.js        | 待生成   |
| PT-401     | test/performance/soak.perf.js         | 待生成   |

**测试脚本示例结构**：
```javascript
// test/performance/baseline-api.perf.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  vus: 10,
  duration: '5m',
  thresholds: {
    http_req_duration: ['p(95)<200'],
    http_req_failed: ['rate<0.01']
  }
};

export default function() {
  const res = http.get('http://localhost:3000/api/endpoint');
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 200ms': (r) => r.timings.duration < 200
  });
  sleep(1);
}
```

---

## 七、性能优化建议（预设）

> 如果性能测试未达标，以下是可能的优化方向

### 7.1 应用层优化

- [ ] 增加缓存（Redis / 内存缓存）
- [ ] 优化数据库查询（添加索引、优化SQL）
- [ ] 启用连接池
- [ ] 实现请求限流
- [ ] 优化算法复杂度

### 7.2 架构层优化

- [ ] 引入负载均衡
- [ ] 数据库读写分离
- [ ] 异步处理（消息队列）
- [ ] 微服务拆分
- [ ] CDN加速（如适用）

### 7.3 基础设施优化

- [ ] 扩展服务器资源（CPU/内存）
- [ ] 数据库性能调优
- [ ] 网络带宽升级

---

## 八、性能测试通过标准

- [ ] 所有基准性能测试达到目标值
- [ ] 负载测试在目标负载下性能达标
- [ ] 压力测试找到性能瓶颈并记录
- [ ] 峰值测试无系统崩溃
- [ ] 耐久性测试无性能下降趋势
- [ ] 资源使用率在合理范围内

---

## 九、性能测试报告

> 测试执行后生成，路径：`docs/testing/iteration-X/性能测试报告.md`

**报告内容**：
- 测试执行摘要
- 性能指标结果对比（目标 vs 实际）
- 性能瓶颈分析
- 资源使用情况分析
- 性能优化建议
- 测试结论

---

## 十、审批信息

**提交人**：AI
**提交时间**：YYYY-MM-DD HH:MM:SS
**审批人**：[用户名]
**审批时间**：
**审批结果**：⏳ 待审批 / ✅ 通过 / ❌ 拒绝

**审批意见**：
```
[用户审批意见]
```

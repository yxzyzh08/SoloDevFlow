# 混沌测试方案

> **项目**: [项目名称]
> **版本**: [版本号]
> **迭代**: Iteration X
> **日期**: YYYY-MM-DD

---

## 一、混沌测试概述

### 1.1 测试目标

[描述混沌测试的目标，如：验证系统在故障场景下的容错能力、恢复能力和数据一致性]

### 1.2 混沌工程原则

- **建立稳态假设**：定义系统正常运行时的稳态指标
- **模拟真实故障**：注入与生产环境可能发生的故障
- **在生产环境或近似生产环境中运行**（测试环境模拟生产配置）
- **自动化执行**：混沌实验可重复执行
- **最小化爆炸半径**：控制故障影响范围

### 1.3 测试工具

- **故障注入工具**：[如 Chaos Mesh / Pumba / toxiproxy]
- **监控工具**：[如 Prometheus + Grafana]
- **日志分析工具**：[如 ELK / Loki]

---

## 二、稳态定义

### 2.1 系统稳态指标

| 指标名称           | 稳态值              | 监控方式               |
| ------------------ | ------------------- | ---------------------- |
| **服务可用性**     | >= 99%              | 健康检查端点           |
| **API响应时间**    | P95 < 500ms         | 性能监控               |
| **错误率**         | < 1%                | 日志聚合               |
| **数据一致性**     | 100%                | 数据验证脚本           |
| **事务成功率**     | >= 99%              | 业务指标监控           |

### 2.2 稳态验证脚本

**验证方式**：在故障注入前后执行稳态验证脚本，对比结果

**稳态验证内容**：
```bash
# 验证服务可用性
curl http://localhost:3000/health
# 期望：HTTP 200

# 验证关键API响应
curl http://localhost:3000/api/critical-endpoint
# 期望：HTTP 200 且响应时间 < 500ms

# 验证数据一致性
npm run test:data-consistency
# 期望：所有检查通过
```

---

## 三、混沌测试场景

### 3.1 基础设施故障

#### CT-001：服务进程崩溃

**故障描述**：应用服务进程突然终止

**故障注入方式**：
```bash
# 使用kill命令模拟进程崩溃
kill -9 <process_id>
```

**预期系统行为**：
- [ ] 进程管理器（如PM2/Supervisor）自动重启服务
- [ ] 重启时间 < 10s
- [ ] 重启后服务恢复正常
- [ ] 无数据丢失
- [ ] 日志记录了崩溃事件

**验证步骤**：
1. 记录故障注入前的稳态指标
2. 杀死服务进程
3. 观察服务自动重启
4. 验证重启后稳态指标恢复
5. 检查数据一致性

**恢复时间目标（RTO）**：< 10s
**数据丢失目标（RPO）**：0（无数据丢失）

---

#### CT-002：数据库连接中断

**故障描述**：应用与数据库之间的网络连接突然中断

**故障注入方式**：
```bash
# 使用iptables阻断数据库端口
iptables -A INPUT -p tcp --dport 5432 -j DROP
```

**预期系统行为**：
- [ ] 应用检测到数据库不可用
- [ ] 返回友好的错误信息（HTTP 503）
- [ ] 日志记录数据库连接失败
- [ ] 连接池自动重试连接
- [ ] 网络恢复后自动重新连接
- [ ] 无需手动重启服务

**验证步骤**：
1. 阻断数据库连接
2. 验证API返回503错误
3. 恢复数据库连接（移除iptables规则）
4. 验证服务自动恢复
5. 验证后续请求正常处理

**恢复时间目标（RTO）**：< 30s
**错误响应**：HTTP 503 Service Unavailable

---

#### CT-003：磁盘空间耗尽

**故障描述**：服务器磁盘空间满

**故障注入方式**：
```bash
# 创建大文件填满磁盘
dd if=/dev/zero of=/tmp/bigfile bs=1M count=10000
```

**预期系统行为**：
- [ ] 应用检测到磁盘空间不足
- [ ] 停止写入新日志文件（或使用日志轮转）
- [ ] 返回错误信息（HTTP 507 Insufficient Storage）
- [ ] 告警系统发出通知
- [ ] 清理磁盘后服务恢复正常

**验证步骤**：
1. 填满磁盘空间
2. 验证应用响应（503或507）
3. 删除临时文件恢复空间
4. 验证服务恢复

---

### 3.2 网络故障

#### CT-101：网络延迟

**故障描述**：网络请求延迟显著增加

**故障注入方式**：
```bash
# 使用tc命令增加网络延迟
tc qdisc add dev eth0 root netem delay 500ms
```

**预期系统行为**：
- [ ] 请求超时机制生效
- [ ] 超时后返回明确错误（HTTP 504 Gateway Timeout）
- [ ] 不会无限期等待
- [ ] 日志记录超时事件

**验证步骤**：
1. 注入500ms网络延迟
2. 发送API请求
3. 验证请求在超时时间内返回或超时
4. 移除延迟，验证恢复

**超时配置**：[如30s]

---

#### CT-102：网络丢包

**故障描述**：网络数据包随机丢失

**故障注入方式**：
```bash
# 使用tc命令模拟20%丢包率
tc qdisc add dev eth0 root netem loss 20%
```

**预期系统行为**：
- [ ] HTTP客户端自动重试失败请求
- [ ] 最终成功或返回明确错误
- [ ] 不会导致数据不一致

**验证步骤**：
1. 注入20%丢包率
2. 发送100个请求
3. 验证大部分请求成功（通过重试）
4. 验证数据一致性

---

#### CT-103：网络分区（脑裂）

**故障描述**：分布式系统中节点间网络隔离

**故障注入方式**：
```bash
# 使用iptables隔离节点
iptables -A INPUT -s <node2_ip> -j DROP
iptables -A OUTPUT -d <node2_ip> -j DROP
```

**预期系统行为**：
- [ ] 系统检测到网络分区
- [ ] 通过共识算法选举新的主节点（如适用）
- [ ] 分区恢复后数据一致性保持
- [ ] 无数据丢失

**验证步骤**（仅适用于分布式系统）：
1. 隔离节点
2. 验证其他节点继续工作
3. 恢复网络
4. 验证数据同步

---

### 3.3 依赖服务故障

#### CT-201：外部API不可用

**故障描述**：系统依赖的外部API服务不可用

**故障注入方式**：
- 使用Mock服务返回500错误
- 或使用网络规则阻断外部API

**预期系统行为**：
- [ ] 系统检测到外部API失败
- [ ] 使用降级策略（返回缓存数据或默认值）
- [ ] 或返回明确错误信息
- [ ] 不影响系统核心功能
- [ ] 日志记录外部依赖失败

**验证步骤**：
1. Mock外部API返回500
2. 调用依赖外部API的功能
3. 验证降级策略生效
4. 恢复外部API
5. 验证功能恢复正常

**降级策略**：[描述降级方案，如返回缓存数据]

---

#### CT-202：缓存服务（Redis）故障

**故障描述**：Redis缓存服务不可用

**故障注入方式**：
```bash
# 停止Redis服务
systemctl stop redis
# 或阻断Redis端口
iptables -A INPUT -p tcp --dport 6379 -j DROP
```

**预期系统行为**：
- [ ] 系统检测到缓存不可用
- [ ] 降级到直接查询数据库
- [ ] 响应时间增加但功能正常
- [ ] 日志记录缓存失败事件
- [ ] Redis恢复后自动重新使用缓存

**验证步骤**：
1. 停止Redis
2. 发送需要缓存的请求
3. 验证请求成功（降级到数据库）
4. 重启Redis
5. 验证缓存重新启用

**性能降级预期**：响应时间从 < 100ms 增加到 < 500ms

---

### 3.4 资源耗尽故障

#### CT-301：CPU高负载

**故障描述**：服务器CPU使用率接近100%

**故障注入方式**：
```bash
# 使用stress工具模拟CPU负载
stress --cpu 8 --timeout 60s
```

**预期系统行为**：
- [ ] 系统响应时间增加但仍可用
- [ ] 请求队列机制生效
- [ ] 不会出现服务崩溃
- [ ] 监控告警触发
- [ ] 负载降低后恢复正常

**验证步骤**：
1. 启动CPU压力测试
2. 发送API请求
3. 验证请求成功但响应时间增加
4. 停止压力测试
5. 验证响应时间恢复

---

#### CT-302：内存耗尽

**故障描述**：应用内存使用接近系统限制

**故障注入方式**：
```bash
# 使用stress工具模拟内存占用
stress --vm 1 --vm-bytes 2G --timeout 60s
```

**预期系统行为**：
- [ ] 系统触发垃圾回收
- [ ] 或返回内存不足错误
- [ ] 不会导致系统OOM Killer杀死进程
- [ ] 监控告警触发

**验证步骤**：
1. 注入内存压力
2. 观察应用内存使用
3. 验证系统响应
4. 停止压力测试
5. 验证内存释放

---

#### CT-303：数据库连接池耗尽

**故障描述**：数据库连接池中所有连接被占用

**故障注入方式**：
- 并发发送大量慢查询请求
- 占满连接池

**预期系统行为**：
- [ ] 新请求等待可用连接
- [ ] 等待超时后返回明确错误（HTTP 503）
- [ ] 不会无限期阻塞
- [ ] 日志记录连接池耗尽
- [ ] 慢查询完成后连接释放，系统恢复

**验证步骤**：
1. 发送N个慢查询（N = 连接池大小）
2. 发送新请求
3. 验证新请求等待或返回503
4. 慢查询完成后验证恢复

---

### 3.5 数据一致性测试

#### CT-401：并发更新冲突

**故障描述**：多个请求同时更新同一数据

**测试场景**：
```javascript
// 并发发送10个更新同一用户余额的请求
for (let i = 0; i < 10; i++) {
  updateBalance(userId, +10);
}
```

**预期系统行为**：
- [ ] 使用乐观锁或悲观锁机制
- [ ] 确保最终余额正确（+100）
- [ ] 无数据丢失或覆盖

**验证步骤**：
1. 记录初始余额
2. 并发发送10个 +10 请求
3. 验证最终余额 = 初始余额 + 100
4. 验证数据库事务日志

---

#### CT-402：事务中断恢复

**故障描述**：数据库事务执行过程中服务崩溃

**故障注入方式**：
1. 开始一个多步骤事务
2. 在事务中间杀死进程

**预期系统行为**：
- [ ] 数据库自动回滚未完成的事务
- [ ] 数据保持一致性
- [ ] 无脏数据或部分提交

**验证步骤**：
1. 启动事务（如创建订单：扣库存 → 创建订单 → 扣余额）
2. 在第2步后杀死进程
3. 重启服务
4. 验证库存未扣减、订单未创建、余额未扣减

---

## 四、混沌测试执行计划

### 4.1 测试执行顺序

```
阶段1: 基础设施故障测试（CT-001 ~ CT-003）
  ↓ 验证服务容错能力
阶段2: 网络故障测试（CT-101 ~ CT-103）
  ↓ 验证网络异常处理
阶段3: 依赖服务故障测试（CT-201 ~ CT-202）
  ↓ 验证降级策略
阶段4: 资源耗尽测试（CT-301 ~ CT-303）
  ↓ 验证资源限制处理
阶段5: 数据一致性测试（CT-401 ~ CT-402）
  ↓ 验证数据完整性
生成混沌测试报告
```

### 4.2 安全措施

**测试环境隔离**：
- [ ] 在独立的测试环境执行
- [ ] 不在生产环境执行
- [ ] 测试数据与生产数据隔离

**爆炸半径控制**：
- [ ] 每次只注入一个故障
- [ ] 控制故障持续时间
- [ ] 设置自动恢复机制

**回滚准备**：
- [ ] 准备快速恢复脚本
- [ ] 备份测试数据
- [ ] 设置监控告警

---

## 五、混沌测试代码映射

> 混沌测试脚本由AI在实现阶段生成

| 测试用例ID | 测试脚本文件                            | 状态     |
| ---------- | --------------------------------------- | -------- |
| CT-001     | test/chaos/process-crash.chaos.js       | 待生成   |
| CT-002     | test/chaos/db-connection.chaos.js       | 待生成   |
| CT-101     | test/chaos/network-latency.chaos.js     | 待生成   |
| CT-201     | test/chaos/external-api.chaos.js        | 待生成   |
| CT-301     | test/chaos/cpu-load.chaos.js            | 待生成   |
| CT-401     | test/chaos/concurrent-update.chaos.js   | 待生成   |

**测试脚本示例结构**：
```javascript
// test/chaos/db-connection.chaos.js
import { injectFault, verifySystemState } from './utils';

describe('Chaos Test: Database Connection Failure', () => {

  beforeAll(async () => {
    // 验证稳态
    await verifySystemState();
  });

  it('should handle database connection loss', async () => {
    // 1. 注入故障
    await injectFault('block-db-port', { port: 5432 });

    // 2. 验证系统行为
    const response = await fetch('/api/endpoint');
    expect(response.status).toBe(503);

    // 3. 恢复故障
    await injectFault('restore-db-port', { port: 5432 });

    // 4. 验证系统恢复
    await wait(30000); // 等待30s
    const response2 = await fetch('/api/endpoint');
    expect(response2.status).toBe(200);
  });

  afterAll(async () => {
    // 清理并验证稳态恢复
    await verifySystemState();
  });
});
```

---

## 六、故障注入工具配置

### 6.1 网络故障注入（使用tc）

```bash
# 增加延迟
tc qdisc add dev eth0 root netem delay 100ms

# 增加丢包
tc qdisc add dev eth0 root netem loss 10%

# 清除规则
tc qdisc del dev eth0 root
```

### 6.2 防火墙规则（使用iptables）

```bash
# 阻断端口
iptables -A INPUT -p tcp --dport 5432 -j DROP

# 恢复
iptables -D INPUT -p tcp --dport 5432 -j DROP
```

### 6.3 资源压力（使用stress）

```bash
# CPU压力
stress --cpu 4 --timeout 60s

# 内存压力
stress --vm 1 --vm-bytes 1G --timeout 60s

# 磁盘压力
stress --io 4 --timeout 60s
```

---

## 七、监控与观察

### 7.1 监控指标

**实时监控**：
- 服务可用性
- API响应时间
- 错误率
- CPU/内存/磁盘使用率
- 数据库连接数

**告警配置**：
- 服务不可用告警
- 响应时间超过阈值告警
- 错误率超过阈值告警

### 7.2 日志分析

**关键日志**：
- 故障注入时间点
- 系统检测到故障的时间点
- 系统恢复的时间点
- 错误堆栈和异常信息

---

## 八、混沌测试通过标准

- [ ] 所有基础设施故障测试通过（系统可恢复）
- [ ] 所有网络故障测试通过（超时机制生效）
- [ ] 所有依赖服务故障测试通过（降级策略生效）
- [ ] 所有资源耗尽测试通过（无服务崩溃）
- [ ] 所有数据一致性测试通过（无数据丢失或损坏）
- [ ] 所有测试的RTO和RPO目标达成
- [ ] 监控和告警机制正常工作

---

## 九、混沌测试报告

> 测试执行后生成，路径：`docs/testing/iteration-X/混沌测试报告.md`

**报告内容**：
- 测试执行摘要
- 每个场景的测试结果
- RTO/RPO统计
- 发现的容错能力问题
- 改进建议
- 测试结论

---

## 十、审批信息

**提交人**：AI
**提交时间**：YYYY-MM-DD HH:MM:SS
**审批人**：[用户名]
**审批时间**：
**审批结果**：⏳ 待审批 / ✅ 通过 / ❌ 拒绝

**审批意见**：
```
[用户审批意见]
```

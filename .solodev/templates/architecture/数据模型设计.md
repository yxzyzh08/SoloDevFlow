# 数据模型设计

> **项目**: [项目名称]
> **版本**: [版本号]
> **迭代**: Iteration X
> **日期**: YYYY-MM-DD

---

## 一、核心数据文件

### 1.1 state.json - 项目状态管理

**文件路径**：`.solodev/state.json`

**用途**：[描述此文件的用途]

#### 完整 Schema

```json
{
  "schema_version": "1.0.0",
  "project": {
    "name": "string",
    "description": "string",
    "createdAt": "ISO8601 string",
    "updatedAt": "ISO8601 string"
  },
  "currentIteration": "string",
  "iterations": {
    "[iterationId]": {
      "id": "string",
      "version": "string",
      "goal": "string",
      "status": "in_progress | completed",
      "startedAt": "ISO8601 string",
      "completedAt": "ISO8601 string | null",
      "currentPhase": "requirements | architecture | implementation | testing | deployment",
      "phases": {
        "[phaseName]": {
          "status": "pending | in_progress | approved | blocked | completed",
          "modules": {
            "[moduleName]": {
              "status": "pending | in_progress | approved | completed",
              "artifacts": ["string[]"]
            }
          }
        }
      }
    }
  },
  "moduleDependencies": {
    "[moduleName]": {
      "dependsOn": ["string[]"],
      "isFoundation": "boolean",
      "description": "string",
      "integrationPoints": [
        {
          "targetModule": "string",
          "interface": "string",
          "purpose": "string",
          "dataFlow": "string",
          "errorHandling": "string",
          "complexity": "simple | complex",
          "integrationDoc": "string | null"
        }
      ]
    }
  },
  "globalTasks": {
    "pending": ["Task[]"],
    "in_progress": ["Task[]"],
    "completed": ["Task[]"]
  },
  "changeHistory": ["Change[]"],
  "metadata": {
    "lastGitCommit": "string",
    "lastGitCommitMessage": "string",
    "lastGitCommitAt": "ISO8601 string",
    "stateFileVersion": "number",
    "totalStateChanges": "number"
  }
}
```

#### 核心字段说明

**项目信息（project）**

| 字段名          | 类型     | 必填 | 说明                   |
| --------------- | -------- | ---- | ---------------------- |
| `name`          | string   | 是   | 项目名称               |
| `description`   | string   | 是   | 项目描述               |
| `createdAt`     | string   | 是   | 项目创建时间（ISO8601）|
| `updatedAt`     | string   | 是   | 最后更新时间（ISO8601）|

**迭代信息（iterations）**

| 字段名          | 类型     | 必填 | 说明                   |
| --------------- | -------- | ---- | ---------------------- |
| `id`            | string   | 是   | 迭代唯一标识           |
| `version`       | string   | 是   | 版本号（如 v1.0）      |
| `goal`          | string   | 是   | 迭代目标               |
| `status`        | enum     | 是   | in_progress / completed|
| `currentPhase`  | enum     | 是   | 当前所处阶段           |

**模块依赖（moduleDependencies）**

| 字段名              | 类型     | 必填 | 说明                       |
| ------------------- | -------- | ---- | -------------------------- |
| `dependsOn`         | string[] | 是   | 依赖的模块列表             |
| `isFoundation`      | boolean  | 是   | 是否为基础模块             |
| `integrationPoints` | array    | 否   | 集成点详细信息（复杂集成） |

**集成点（integrationPoints）**

| 字段名              | 类型     | 必填 | 说明                               |
| ------------------- | -------- | ---- | ---------------------------------- |
| `targetModule`      | string   | 是   | 目标模块名称                       |
| `interface`         | string   | 是   | 调用的接口名称                     |
| `purpose`           | string   | 是   | 调用目的                           |
| `dataFlow`          | string   | 是   | 数据流向（输入 -> 输出）           |
| `errorHandling`     | string   | 是   | 错误处理方式                       |
| `complexity`        | enum     | 是   | simple / complex                   |
| `integrationDoc`    | string   | 否   | 集成文档路径（仅 complex 时需要）  |

#### 状态流转规则

**迭代状态流转**：
```
pending → in_progress → completed
```

**阶段状态流转**：
```
pending → in_progress → approved → completed
                          ↓
                       blocked（如果发现问题）
```

**模块状态流转**：
```
pending → in_progress → approved → completed
            ↓
     （可以回滚到任意之前状态）
```

#### 数据完整性约束

**约束1：currentIteration 必须存在于 iterations 中**
```typescript
assert(state.iterations[state.currentIteration] !== undefined)
```

**约束2：currentPhase 必须存在于当前迭代的 phases 中**
```typescript
const currentIter = state.iterations[state.currentIteration];
assert(currentIter.phases[currentIter.currentPhase] !== undefined)
```

**约束3：模块依赖关系不能有循环**
```typescript
// 依赖图必须是 DAG（有向无环图）
assertNoCyclicDependencies(state.moduleDependencies)
```

#### 示例数据

```json
{
  "schema_version": "1.0.0",
  "project": {
    "name": "电商平台",
    "description": "一个支持多商户的电商平台",
    "createdAt": "2025-12-13T08:00:00Z",
    "updatedAt": "2025-12-13T16:00:00Z"
  },
  "currentIteration": "iteration-1",
  "iterations": {
    "iteration-1": {
      "id": "iteration-1",
      "version": "v1.0",
      "goal": "MVP - 用户登录 + 基础订单",
      "status": "in_progress",
      "currentPhase": "requirements",
      "phases": {
        "requirements": {
          "status": "in_progress",
          "modules": {
            "用户模块": {
              "status": "approved",
              "artifacts": ["docs/requirements/iteration-1/用户模块-PRD.md"]
            },
            "订单模块": {
              "status": "in_progress",
              "artifacts": []
            }
          }
        }
      }
    }
  },
  "moduleDependencies": {
    "用户模块": {
      "dependsOn": [],
      "isFoundation": true,
      "description": "基础模块"
    },
    "订单模块": {
      "dependsOn": ["用户模块"],
      "isFoundation": false,
      "description": "订单管理模块",
      "integrationPoints": [
        {
          "targetModule": "用户模块",
          "interface": "getUserInfo(userId)",
          "purpose": "获取用户信息用于订单创建",
          "dataFlow": "userId -> UserInfo",
          "errorHandling": "throw UserNotFoundError",
          "complexity": "simple"
        }
      ]
    }
  }
}
```

---

### 1.2 [其他数据文件] - [用途]

**文件路径**：`[路径]`

**用途**：[描述]

#### Schema

```json
[Schema 定义]
```

#### 字段说明

[字段说明表格]

---

## 二、核心实体抽象

### 2.1 Iteration（迭代）

**概念模型**：
```
Iteration 表示一个完整的开发迭代，对应一个版本号
  ├─ 包含多个阶段（requirements, architecture, ...）
  ├─ 每个阶段包含多个模块
  └─ 迭代完成后部署上线
```

**状态机**：
```
[Iteration 状态机图]
pending → in_progress → completed
```

**关键操作**：
- `startIteration()` - 开始迭代
- `completeIteration()` - 完成迭代
- `moveToPhase(phase)` - 进入下一阶段

---

### 2.2 Module（模块）

**概念模型**：
```
Module 表示系统的一个功能模块
  ├─ 有明确的职责边界
  ├─ 可能依赖其他模块
  └─ 在每个阶段都有对应的产物
```

**依赖关系**：
```
[模块依赖关系图]
```

**关键操作**：
- `getModuleDependencies(moduleName)` - 获取模块依赖
- `getAffectedModules(moduleName)` - 获取受影响模块
- `validateDependencies()` - 验证依赖关系

---

### 2.3 Phase（阶段）

**概念模型**：
```
Phase 表示开发的一个阶段
  ├─ requirements（需求分析）
  ├─ architecture（架构设计）
  ├─ implementation（代码实现）
  ├─ testing（测试验证）
  └─ deployment（部署）
```

**阶段流转规则**：
```
requirements → architecture → implementation → testing → deployment
     ↑                                              ↓
     └──────────────── (回滚) ────────────────────┘
```

---

## 三、数据操作接口

### 3.1 状态读取

```typescript
interface StateReader {
  getCurrentIteration(): Iteration;
  getCurrentPhase(): Phase;
  getModuleStatus(moduleName: string): ModuleStatus;
  getModuleDependencies(moduleName: string): string[];
}
```

### 3.2 状态更新

```typescript
interface StateWriter {
  updateIterationStatus(iterationId: string, status: IterationStatus): void;
  updatePhaseStatus(phase: string, status: PhaseStatus): void;
  updateModuleStatus(moduleName: string, status: ModuleStatus): void;
  addChangeHistory(change: Change): void;
}
```

### 3.3 状态验证

```typescript
interface StateValidator {
  validateStateIntegrity(): ValidationResult;
  validateDependencies(): ValidationResult;
  validatePhaseTransition(from: Phase, to: Phase): boolean;
}
```

---

## 四、数据迁移

### 4.1 Schema 版本管理

当前 Schema 版本：`1.0.0`

**版本历史**：
| 版本   | 日期       | 变更说明           |
| ------ | ---------- | ------------------ |
| 1.0.0  | 2025-12-13 | 初始版本           |

### 4.2 迁移脚本

**v1.0.0 → v1.1.0（示例）**：
```typescript
function migrate_1_0_to_1_1(state: State_v1_0): State_v1_1 {
  // 迁移逻辑
  return newState;
}
```

---

## 五、数据备份与恢复

### 5.1 备份策略

- **自动备份**：每次 state.json 更新时，Git commit 即为备份
- **手动备份**：可通过命令创建快照

### 5.2 恢复策略

```bash
# 恢复到指定 commit
git checkout <commit-hash> -- .solodev/state.json
```

---

## 六、性能优化

### 6.1 数据访问优化

- **缓存策略**：[如何缓存 state.json]
- **懒加载**：[如何懒加载大数据]

### 6.2 文件大小限制

- **state.json 预计大小**：[估算]
- **超过限制的处理**：[策略]

# 命令体系模块 - 数据模型设计

<!--
章节ID规范说明：
- 格式：{#data-命令体系-[章节标识]}
- 必须标注ID的章节：Schema定义、类型定义、接口定义
- 示例：{#data-命令体系-命令定义} 表示命令体系模块数据模型的命令定义章节
-->

> **项目**: AI超级个体开发助手
> **版本**: v1.0.0
> **迭代**: Iteration 1
> **模块**: 命令体系模块
> **日期**: 2025-12-15

---

## 一、数据模型概述

### 1.1 数据分类

命令体系模块的数据分为三类：

| 数据类别 | 存储位置 | 说明 |
|---------|---------|------|
| **命令定义数据** | .claude/commands/*.md | 命令的元信息和执行流程 |
| **运行时数据** | 内存 | 命令解析结果、执行上下文 |
| **状态数据** | state.json (由状态管理模块管理) | 阶段状态、模块状态 |

### 1.2 数据流向

```
命令定义文件 (.claude/commands/*.md)
     ↓ 读取
命令解析器 → ParsedCommand
     ↓
前置条件检查器 → PreconditionResult
     ↓
上下文加载器 → ExecutionContext
     ↓
步骤执行器 → ExecutionResult
     ↓
状态管理模块 → state.json更新
```

---

## 二、命令定义数据模型 {#data-命令体系-命令定义}

### 2.1 命令定义Schema

命令定义存储在Markdown文件中，包含以下结构化信息：

```typescript
/**
 * CommandDefinition - 命令定义
 * 从 .claude/commands/*.md 文件解析得到
 */
interface CommandDefinition {
  /** 命令名称（不含/前缀） */
  name: string;

  /** 命令描述 */
  description: string;

  /** 参数定义 */
  parameters: ParameterDefinition[];

  /** 前置条件列表 */
  preconditions: PreconditionDefinition[];

  /** 执行步骤 */
  steps: ExecutionStepDefinition[];

  /** 是否需要审批 */
  approvalRequired: boolean;

  /** 审批命令（如果需要审批） */
  approvalCommand?: string;

  /** 错误处理规则 */
  errorHandling: ErrorHandlingRule[];
}

/**
 * ParameterDefinition - 参数定义
 */
interface ParameterDefinition {
  /** 参数名称 */
  name: string;

  /** 参数类型 */
  type: 'string' | 'boolean' | 'string[]';

  /** 是否必需 */
  required: boolean;

  /** 默认值 */
  defaultValue?: string | boolean | string[];

  /** 参数描述 */
  description: string;

  /** 参数格式（正则表达式） */
  pattern?: string;

  /** 可选值列表 */
  enum?: string[];
}

/**
 * PreconditionDefinition - 前置条件定义
 */
interface PreconditionDefinition {
  /** 条件类型 */
  type: PreconditionType;

  /** 相关阶段（部分类型需要） */
  phase?: string;

  /** 相关模块（部分类型需要） */
  modules?: string[];

  /** 失败时的错误消息 */
  errorMessage: string;

  /** 严重程度 */
  severity: 'error' | 'warning';
}

/**
 * 前置条件类型
 */
type PreconditionType =
  | 'state_not_exists'    // state.json不存在（用于/init命令）
  | 'state_exists'        // state.json存在
  | 'phase_completed'     // 指定阶段已完成
  | 'phase_approved'      // 指定阶段已审批
  | 'phase_in_progress'   // 指定阶段进行中
  | 'modules_approved'    // 指定模块已审批
  | 'iteration_not_started' // 迭代未开始
  | 'custom';             // 自定义条件

/**
 * ExecutionStepDefinition - 执行步骤定义
 */
interface ExecutionStepDefinition {
  /** 步骤序号 */
  order: number;

  /** 步骤描述 */
  description: string;

  /** 步骤类型 */
  type: ExecutionStepType;

  /** 步骤参数 */
  params: Record<string, unknown>;

  /** 是否可跳过 */
  skippable: boolean;

  /** 跳过条件 */
  skipCondition?: string;
}

/**
 * 执行步骤类型
 */
type ExecutionStepType =
  | 'read_state'          // 读取状态
  | 'update_state'        // 更新状态
  | 'load_context'        // 加载上下文
  | 'read_template'       // 读取模板
  | 'generate_document'   // 生成文档
  | 'wait_approval'       // 等待审批
  | 'git_commit'          // Git提交
  | 'custom';             // 自定义步骤

/**
 * ErrorHandlingRule - 错误处理规则
 */
interface ErrorHandlingRule {
  /** 错误场景 */
  scenario: string;

  /** 处理方式 */
  handling: 'abort' | 'warn' | 'retry' | 'skip';

  /** 用户提示消息 */
  userMessage: string;

  /** 建议操作 */
  suggestedAction?: string;
}
```

### 2.2 命令定义示例

**start-requirements命令定义**：

```typescript
const startRequirementsDefinition: CommandDefinition = {
  name: 'start-requirements',
  description: '启动需求分析阶段，开始新迭代的第一步',
  parameters: [
    {
      name: 'module',
      type: 'string',
      required: false,
      description: '指定单个模块进行需求分析',
      pattern: '^[\\u4e00-\\u9fa5a-zA-Z]+$'
    }
  ],
  preconditions: [
    {
      type: 'state_exists',
      errorMessage: 'state.json不存在，请先初始化项目',
      severity: 'error'
    },
    {
      type: 'iteration_not_started',
      errorMessage: '当前迭代已开始，无法重新启动需求分析',
      severity: 'error'
    }
  ],
  steps: [
    {
      order: 1,
      description: '读取当前状态',
      type: 'read_state',
      params: {},
      skippable: false
    },
    {
      order: 2,
      description: '更新阶段状态为requirements',
      type: 'update_state',
      params: {
        currentPhase: 'requirements',
        'phases.requirements.status': 'in_progress',
        'phases.requirements.startedAt': '${timestamp}'
      },
      skippable: false
    },
    {
      order: 3,
      description: '加载需求阶段上下文',
      type: 'load_context',
      params: {
        phase: 'requirements'
      },
      skippable: false
    },
    {
      order: 4,
      description: '读取PRD模板',
      type: 'read_template',
      params: {
        templatePath: '.solodev/templates/PRD-project-template.md'
      },
      skippable: false
    },
    {
      order: 5,
      description: '逐模块澄清需求并生成PRD',
      type: 'generate_document',
      params: {
        outputPath: 'docs/PRD/',
        templateType: 'prd'
      },
      skippable: false
    },
    {
      order: 6,
      description: '等待用户审批',
      type: 'wait_approval',
      params: {
        approvalCommand: '/approve-requirements',
        message: '需求分析完成，请审批PRD文档'
      },
      skippable: false
    }
  ],
  approvalRequired: true,
  approvalCommand: '/approve-requirements',
  errorHandling: [
    {
      scenario: 'state.json不存在',
      handling: 'abort',
      userMessage: 'state.json不存在，请先初始化项目',
      suggestedAction: '执行 /init 初始化项目'
    },
    {
      scenario: '模块不存在',
      handling: 'abort',
      userMessage: '指定的模块不存在',
      suggestedAction: '检查模块名称是否正确'
    }
  ]
};
```

---

## 三、运行时数据模型 {#data-命令体系-运行时数据}

### 3.1 命令解析结果

```typescript
/**
 * ParsedCommand - 命令解析结果
 */
interface ParsedCommand {
  /** 解析结果类型 */
  type: 'command';

  /** 命令名称（不含/前缀） */
  name: string;

  /** 解析后的参数 */
  args: CommandArgs;

  /** 原始输入 */
  rawInput: string;

  /** 解析时间戳 */
  parsedAt: string;
}

/**
 * HelpRequest - 帮助请求（当命令包含 --help 或 -h 时）
 */
interface HelpRequest {
  /** 解析结果类型 */
  type: 'help';

  /** 请求帮助的命令名称 */
  command: string;
}

/**
 * CommandHelp - 命令帮助信息
 */
interface CommandHelp {
  /** 命令名称 */
  name: string;

  /** 命令描述 */
  description: string;

  /** 使用格式 */
  usage: string;

  /** 参数说明 */
  parameters: ParameterInfo[];

  /** 使用示例 */
  examples: string[];
}

/**
 * CommandArgs - 命令参数
 */
interface CommandArgs {
  /** 位置参数 */
  positional: string[];

  /** 命名参数 */
  named: Record<string, string | string[]>;
}
```

### 3.2 前置条件检查结果

```typescript
/**
 * PreconditionResult - 前置条件检查结果
 */
interface PreconditionResult {
  /** 是否通过 */
  passed: boolean;

  /** 错误列表（阻止执行） */
  errors: PreconditionError[];

  /** 警告列表（不阻止执行） */
  warnings: PreconditionWarning[];

  /** 检查耗时(ms) */
  duration: number;
}

/**
 * PreconditionError - 前置条件错误
 */
interface PreconditionError {
  /** 条件类型 */
  type: PreconditionType;

  /** 错误消息 */
  message: string;

  /** 建议操作 */
  suggestedAction?: string;
}

/**
 * PreconditionWarning - 前置条件警告
 */
interface PreconditionWarning {
  /** 条件类型 */
  type: PreconditionType;

  /** 警告消息 */
  message: string;
}
```

### 3.3 执行上下文

```typescript
/**
 * ExecutionContext - 命令执行上下文
 */
interface ExecutionContext {
  /** 上下文类型 */
  type: 'phase' | 'module' | 'custom' | 'minimal';

  /** 当前阶段 */
  phase: string;

  /** 当前模块（模块级上下文时） */
  module?: string;

  /** 模块列表（自定义上下文时） */
  modules?: string[];

  /** 文档列表 */
  documents: ContextDocument[];

  /** 状态字段 */
  stateFields: StateFieldRef[];

  /** 依赖模块 */
  dependencies?: string[];

  /** 元数据 */
  metadata: ContextMetadata;
}

/**
 * ContextDocument - 上下文文档
 */
interface ContextDocument {
  /** 文档路径 */
  path: string;

  /** 文档类型 */
  type: 'prd' | 'architecture' | 'test' | 'deployment' | 'other';

  /** 所属模块 */
  module?: string;

  /** 是否必需 */
  required: boolean;

  /** 是否存在 */
  exists: boolean;
}

/**
 * StateFieldRef - 状态字段引用
 */
interface StateFieldRef {
  /** 字段路径 */
  path: string;

  /** 字段描述 */
  description: string;

  /** 当前值 */
  value: unknown;
}

/**
 * ContextMetadata - 上下文元数据
 */
interface ContextMetadata {
  /** 加载时间戳 */
  loadedAt: string;

  /** 文档总数 */
  totalDocuments: number;

  /** 估算大小(KB) */
  estimatedSizeKB: number;

  /** 是否超限 */
  exceedsLimit: boolean;
}
```

### 3.4 执行结果

```typescript
/**
 * ExecutionResult - 命令执行结果
 */
interface ExecutionResult {
  /** 是否成功 */
  success: boolean;

  /** 命令名称 */
  command: string;

  /** 执行消息 */
  message: string;

  /** 错误信息（失败时） */
  errors?: string[];

  /** 警告信息 */
  warnings?: string[];

  /** 是否在审批点暂停 */
  waitingForApproval: boolean;

  /** 审批信息（如果在审批点） */
  approvalInfo?: ApprovalPointInfo;

  /** 建议的下一步操作 */
  nextAction?: string;

  /** 产出文档 */
  artifacts: string[];

  /** 执行耗时(ms) */
  duration: number;

  /** 执行步骤记录 */
  stepResults: StepResult[];
}

/**
 * StepResult - 步骤执行结果
 */
interface StepResult {
  /** 步骤序号 */
  order: number;

  /** 步骤描述 */
  description: string;

  /** 是否成功 */
  success: boolean;

  /** 是否跳过 */
  skipped: boolean;

  /** 错误信息（失败时） */
  error?: string;

  /** 耗时(ms) */
  duration: number;
}

/**
 * ApprovalPointInfo - 审批点信息
 */
interface ApprovalPointInfo {
  /** 阶段 */
  phase: string;

  /** 审批命令 */
  approvalCommand: string;

  /** 需要审批的文档 */
  requiredArtifacts: string[];

  /** 审批提示消息 */
  message: string;

  /** 审批截止时间（如有） */
  deadline?: string;
}
```

---

## 四、审批相关数据模型 {#data-命令体系-审批数据}

### 4.1 审批请求

```typescript
/**
 * ApprovalRequest - 审批请求
 */
interface ApprovalRequest {
  /** 阶段 */
  phase: string;

  /** 审批人 */
  approvedBy: string;

  /** 审批时间 */
  approvedAt: string;

  /** 审批备注 */
  comment?: string;
}
```

### 4.2 审批结果

```typescript
/**
 * ApprovalResult - 审批结果
 */
interface ApprovalResult {
  /** 是否成功 */
  success: boolean;

  /** 错误信息（失败时） */
  errors?: string[];

  /** 审批时间（成功时） */
  approvedAt?: string;

  /** 下一步操作建议 */
  nextAction?: string;
}
```

---

## 五、命令清单数据模型 {#data-命令体系-命令清单}

### 5.1 核心命令定义

```typescript
/**
 * 命令清单
 */
const COMMAND_REGISTRY: CommandInfo[] = [
  {
    name: 'init',
    description: '初始化新项目',
    category: 'setup',
    targetPhase: null,
    parameters: [],  // 无命令参数，项目信息通过交互询问获取
    interactiveInputs: [
      { prompt: '请输入项目名称：', type: 'text', field: 'projectName' },
      { prompt: '请选择项目类型：1) backend  2) frontend  3) fullstack', type: 'choice', field: 'projectType', options: ['backend', 'frontend', 'fullstack'] }
    ],
    preconditionTypes: ['state_not_exists'],  // 项目未初始化时才能执行
    needsApproval: false
  },
  {
    name: 'start-requirements',
    description: '启动需求分析阶段',
    category: 'phase',
    targetPhase: 'requirements',
    parameters: [
      { name: 'module', type: 'string', required: false, description: '指定单个模块' }
    ],
    preconditionTypes: ['state_exists', 'iteration_not_started'],
    needsApproval: true
  },
  {
    name: 'approve-requirements',
    description: '审批需求文档',
    category: 'approval',
    targetPhase: 'requirements',
    parameters: [],
    preconditionTypes: ['state_exists', 'phase_in_progress'],
    needsApproval: false
  },
  {
    name: 'start-architecture',
    description: '启动架构设计阶段',
    category: 'phase',
    targetPhase: 'architecture',
    parameters: [
      { name: 'module', type: 'string', required: false, description: '指定单个模块' }
    ],
    preconditionTypes: ['state_exists', 'phase_approved'],
    needsApproval: true
  },
  {
    name: 'approve-architecture',
    description: '审批架构文档',
    category: 'approval',
    targetPhase: 'architecture',
    parameters: [],
    preconditionTypes: ['state_exists', 'phase_in_progress'],
    needsApproval: false
  },
  {
    name: 'start-implementation',
    description: '启动实现阶段',
    category: 'phase',
    targetPhase: 'implementation',
    parameters: [
      { name: 'module', type: 'string', required: false, description: '指定单个模块' }
    ],
    preconditionTypes: ['state_exists', 'phase_approved'],
    needsApproval: false
  },
  {
    name: 'start-testing',
    description: '启动测试阶段',
    category: 'phase',
    targetPhase: 'testing',
    parameters: [],
    preconditionTypes: ['state_exists', 'phase_completed'],
    needsApproval: true  // E2E/性能/混沌测试都需要审批
  },
  {
    name: 'start-deployment',
    description: '启动部署阶段',
    category: 'phase',
    targetPhase: 'deployment',
    parameters: [],
    preconditionTypes: ['state_exists', 'phase_completed'],
    needsApproval: true
  },
  {
    name: 'custom-task',
    description: '创建自定义任务',
    category: 'utility',
    targetPhase: null,
    parameters: [
      { name: 'modules', type: 'string[]', required: false, description: '指定模块列表' },
      { name: 'description', type: 'string', required: true, description: '任务描述' }
    ],
    preconditionTypes: ['state_exists'],
    needsApproval: false
  }
];

/**
 * CommandInfo - 命令信息
 */
interface CommandInfo {
  /** 命令名称 */
  name: string;

  /** 命令描述 */
  description: string;

  /** 命令类别 */
  category: 'setup' | 'phase' | 'approval' | 'utility';

  /** 目标阶段（阶段命令时） */
  targetPhase: string | null;

  /** 参数定义 */
  parameters: ParameterInfo[];

  /** 前置条件类型 */
  preconditionTypes: PreconditionType[];

  /** 是否需要审批 */
  needsApproval: boolean;
}

/**
 * ParameterInfo - 参数信息
 */
interface ParameterInfo {
  /** 参数名称 */
  name: string;

  /** 参数类型 */
  type: 'string' | 'boolean' | 'string[]';

  /** 是否必需 */
  required: boolean;

  /** 参数描述 */
  description: string;
}
```

---

## 六、错误类型定义 {#data-命令体系-错误类型}

### 6.1 命令相关错误

```typescript
/**
 * CommandError - 命令错误基类
 */
abstract class CommandError extends Error {
  abstract readonly code: string;
  abstract readonly httpStatus: number;
  abstract readonly userFriendlyMessage: string;
}

/**
 * InvalidCommandError - 命令格式错误
 */
class InvalidCommandError extends CommandError {
  readonly code = 'INVALID_COMMAND';
  readonly httpStatus = 400;

  constructor(
    message: string,
    public readonly input: string,
    public readonly suggestion?: string
  ) {
    super(message);
  }

  get userFriendlyMessage(): string {
    return this.suggestion
      ? `命令格式错误: ${this.message}\n建议: ${this.suggestion}`
      : `命令格式错误: ${this.message}`;
  }
}

/**
 * CommandNotFoundError - 命令不存在
 */
class CommandNotFoundError extends CommandError {
  readonly code = 'COMMAND_NOT_FOUND';
  readonly httpStatus = 404;

  constructor(
    public readonly commandName: string,
    public readonly availableCommands: string[]
  ) {
    super(`未知命令: /${commandName}`);
  }

  get userFriendlyMessage(): string {
    return `未知命令: /${this.commandName}\n可用命令: ${this.availableCommands.map(c => '/' + c).join(', ')}`;
  }
}

/**
 * PreconditionFailedError - 前置条件不满足
 */
class PreconditionFailedError extends CommandError {
  readonly code = 'PRECONDITION_FAILED';
  readonly httpStatus = 409;

  constructor(
    public readonly conditions: PreconditionError[]
  ) {
    super(`前置条件不满足: ${conditions.map(c => c.message).join('; ')}`);
  }

  get userFriendlyMessage(): string {
    const messages = this.conditions.map(c => {
      return c.suggestedAction
        ? `- ${c.message} (建议: ${c.suggestedAction})`
        : `- ${c.message}`;
    });
    return `无法执行命令，以下条件不满足:\n${messages.join('\n')}`;
  }
}

/**
 * ContextLoadError - 上下文加载失败
 */
class ContextLoadError extends CommandError {
  readonly code = 'CONTEXT_LOAD_ERROR';
  readonly httpStatus = 500;

  constructor(
    message: string,
    public readonly missingDocuments?: string[]
  ) {
    super(message);
  }

  get userFriendlyMessage(): string {
    if (this.missingDocuments && this.missingDocuments.length > 0) {
      return `上下文加载失败: ${this.message}\n缺失文档:\n${this.missingDocuments.map(d => '- ' + d).join('\n')}`;
    }
    return `上下文加载失败: ${this.message}`;
  }
}

/**
 * ApprovalError - 审批错误
 */
class ApprovalError extends CommandError {
  readonly code = 'APPROVAL_ERROR';
  readonly httpStatus = 409;

  constructor(
    message: string,
    public readonly phase: string,
    public readonly currentStatus: string
  ) {
    super(message);
  }

  get userFriendlyMessage(): string {
    return `审批失败: ${this.message}\n阶段: ${this.phase}, 当前状态: ${this.currentStatus}`;
  }
}

/**
 * ExecutionError - 执行错误
 */
class ExecutionError extends CommandError {
  readonly code = 'EXECUTION_ERROR';
  readonly httpStatus = 500;

  constructor(
    message: string,
    public readonly step: number,
    public readonly stepDescription: string
  ) {
    super(message);
  }

  get userFriendlyMessage(): string {
    return `命令执行失败 (步骤${this.step}: ${this.stepDescription})\n错误: ${this.message}`;
  }
}
```

---

## 七、命令与状态的映射 {#data-命令体系-状态映射}

### 7.1 命令-状态变更映射

```typescript
/**
 * 命令执行对状态的影响
 */
const COMMAND_STATE_EFFECTS: Record<string, StateEffect> = {
  'init': {
    // /init 创建全新的 state.json，而非更新现有状态
    creates: {
      schema_version: '1.0.0',
      project: {
        name: '${projectName}',
        type: '${projectType}',
        createdAt: '${timestamp}'
      },
      currentIteration: 'iteration-1',
      iterations: {
        'iteration-1': {
          id: 'iteration-1',
          version: 'v1.0.0',
          status: 'in_progress',
          startedAt: '${timestamp}',
          currentPhase: null  // 待执行 /start-requirements
        }
      },
      moduleDependencies: {},
      globalTasks: { pending: [], completed: [] },
      changeHistory: [],
      settings: {
        autoReadHistory: true,
        requireApprovalForPhaseTransition: true
      },
      metadata: {
        stateFileVersion: 1,
        totalStateChanges: 1,
        lastUpdatedAt: '${timestamp}',
        lastUpdatedBy: 'ai'
      }
    },
    changeHistoryEntry: {
      type: 'init',
      description: '初始化项目'
    }
  },

  'start-requirements': {
    updates: [
      { path: 'iterations.${currentIteration}.currentPhase', value: 'requirements' },
      { path: 'iterations.${currentIteration}.phases.requirements.status', value: 'in_progress' },
      { path: 'iterations.${currentIteration}.phases.requirements.startedAt', value: '${timestamp}' }
    ],
    changeHistoryEntry: {
      type: 'phase_transition',
      description: '启动需求分析阶段'
    }
  },

  'approve-requirements': {
    updates: [
      { path: 'iterations.${currentIteration}.phases.requirements.status', value: 'approved' },
      { path: 'iterations.${currentIteration}.phases.requirements.approvedAt', value: '${timestamp}' },
      { path: 'iterations.${currentIteration}.phases.requirements.approvedBy', value: '${approvedBy}' }
    ],
    changeHistoryEntry: {
      type: 'approval',
      description: '需求阶段审批通过'
    }
  },

  'start-architecture': {
    precondition: {
      path: 'iterations.${currentIteration}.phases.requirements.status',
      expectedValue: 'approved'
    },
    updates: [
      { path: 'iterations.${currentIteration}.currentPhase', value: 'architecture' },
      { path: 'iterations.${currentIteration}.phases.architecture.status', value: 'in_progress' },
      { path: 'iterations.${currentIteration}.phases.architecture.startedAt', value: '${timestamp}' }
    ],
    changeHistoryEntry: {
      type: 'phase_transition',
      description: '启动架构设计阶段'
    }
  },

  'approve-architecture': {
    updates: [
      { path: 'iterations.${currentIteration}.phases.architecture.status', value: 'approved' },
      { path: 'iterations.${currentIteration}.phases.architecture.approvedAt', value: '${timestamp}' },
      { path: 'iterations.${currentIteration}.phases.architecture.approvedBy', value: '${approvedBy}' }
    ],
    changeHistoryEntry: {
      type: 'approval',
      description: '架构阶段审批通过'
    }
  },

  'start-implementation': {
    precondition: {
      path: 'iterations.${currentIteration}.phases.architecture.status',
      expectedValue: 'approved'
    },
    updates: [
      { path: 'iterations.${currentIteration}.currentPhase', value: 'implementation' },
      { path: 'iterations.${currentIteration}.phases.implementation.status', value: 'in_progress' },
      { path: 'iterations.${currentIteration}.phases.implementation.startedAt', value: '${timestamp}' }
    ],
    changeHistoryEntry: {
      type: 'phase_transition',
      description: '启动实现阶段'
    }
  },

  'start-testing': {
    precondition: {
      path: 'iterations.${currentIteration}.phases.implementation.status',
      expectedValue: 'completed'
    },
    updates: [
      { path: 'iterations.${currentIteration}.currentPhase', value: 'testing' },
      { path: 'iterations.${currentIteration}.phases.testing.status', value: 'in_progress' },
      { path: 'iterations.${currentIteration}.phases.testing.startedAt', value: '${timestamp}' }
    ],
    changeHistoryEntry: {
      type: 'phase_transition',
      description: '启动测试阶段'
    }
  },

  'start-deployment': {
    precondition: {
      path: 'iterations.${currentIteration}.phases.testing.status',
      expectedValue: 'completed'
    },
    updates: [
      { path: 'iterations.${currentIteration}.currentPhase', value: 'deployment' },
      { path: 'iterations.${currentIteration}.phases.deployment.status', value: 'in_progress' },
      { path: 'iterations.${currentIteration}.phases.deployment.startedAt', value: '${timestamp}' }
    ],
    changeHistoryEntry: {
      type: 'phase_transition',
      description: '启动部署阶段'
    }
  },

  'custom-task': {
    // 自定义任务不影响状态
    updates: [],
    changeHistoryEntry: null
  }
};

/**
 * StateEffect - 状态影响
 */
interface StateEffect {
  /** 前置条件（可选） */
  precondition?: {
    path: string;
    expectedValue: string;
  };

  /** 状态更新列表 */
  updates: StateUpdate[];

  /** changeHistory记录（如果有） */
  changeHistoryEntry: ChangeHistoryEntry | null;
}

/**
 * StateUpdate - 状态更新
 */
interface StateUpdate {
  /** 字段路径 */
  path: string;

  /** 新值（支持变量占位符） */
  value: string;
}

/**
 * ChangeHistoryEntry - 变更历史记录
 */
interface ChangeHistoryEntry {
  /** 变更类型 */
  type: string;

  /** 变更描述 */
  description: string;
}
```

---

## 八、帮助信息数据模型 {#data-命令体系-帮助信息}

### 8.1 命令帮助

```typescript
/**
 * CommandHelp - 命令帮助信息
 */
interface CommandHelp {
  /** 命令名称 */
  name: string;

  /** 简短描述 */
  shortDescription: string;

  /** 详细描述 */
  longDescription: string;

  /** 用法示例 */
  usage: UsageExample[];

  /** 参数说明 */
  parameters: ParameterHelp[];

  /** 前置条件说明 */
  preconditions: string[];

  /** 相关命令 */
  relatedCommands: string[];

  /** 注意事项 */
  notes: string[];
}

/**
 * UsageExample - 用法示例
 */
interface UsageExample {
  /** 示例命令 */
  command: string;

  /** 示例说明 */
  description: string;
}

/**
 * ParameterHelp - 参数帮助
 */
interface ParameterHelp {
  /** 参数名称 */
  name: string;

  /** 参数类型 */
  type: string;

  /** 是否必需 */
  required: boolean;

  /** 参数描述 */
  description: string;

  /** 默认值 */
  defaultValue?: string;

  /** 示例值 */
  exampleValue?: string;
}
```

### 8.2 帮助信息示例

```typescript
const startArchitectureHelp: CommandHelp = {
  name: 'start-architecture',
  shortDescription: '启动架构设计阶段',
  longDescription: `启动架构设计阶段，根据PRD文档设计系统架构。
此命令会：
1. 验证需求阶段已审批通过
2. 加载需求阶段的上下文（PRD文档）
3. 更新项目状态为架构阶段
4. 逐模块进行架构设计
5. 生成架构文档`,
  usage: [
    {
      command: '/start-architecture',
      description: '启动所有模块的架构设计'
    },
    {
      command: '/start-architecture 核心流程模型',
      description: '仅对核心流程模型进行架构设计'
    }
  ],
  parameters: [
    {
      name: 'module',
      type: 'string',
      required: false,
      description: '指定单个模块进行架构设计',
      exampleValue: '核心流程模型'
    }
  ],
  preconditions: [
    'state.json必须存在',
    '需求阶段必须已审批通过（status=approved）'
  ],
  relatedCommands: [
    '/approve-requirements - 审批需求阶段',
    '/approve-architecture - 审批架构阶段'
  ],
  notes: [
    '架构设计完成后需要执行 /approve-architecture 进行审批',
    '建议按模块依赖顺序进行架构设计'
  ]
};
```

---

## 九、类型导出汇总

```typescript
// 命令定义相关
export type {
  CommandDefinition,
  ParameterDefinition,
  PreconditionDefinition,
  PreconditionType,
  ExecutionStepDefinition,
  ExecutionStepType,
  ErrorHandlingRule
};

// 运行时数据相关
export type {
  ParsedCommand,
  HelpRequest,
  CommandHelp,
  CommandArgs,
  PreconditionResult,
  PreconditionError,
  PreconditionWarning,
  ExecutionContext,
  ContextDocument,
  StateFieldRef,
  ContextMetadata,
  ExecutionResult,
  StepResult
};

// 审批相关
export type {
  ApprovalPointInfo,
  ApprovalRequest,
  ApprovalResult
};

// 命令清单相关
export type {
  CommandInfo,
  ParameterInfo
};

// 错误类型
export {
  CommandError,
  InvalidCommandError,
  CommandNotFoundError,
  PreconditionFailedError,
  ContextLoadError,
  ApprovalError,
  ExecutionError
};

// 帮助信息相关
export type {
  CommandHelp,
  UsageExample,
  ParameterHelp
};

// 状态映射相关
export type {
  StateEffect,
  StateUpdate,
  ChangeHistoryEntry
};

// 常量
export { COMMAND_REGISTRY, COMMAND_STATE_EFFECTS };
```

---

## 十、数据完整性约束

### 10.1 命令定义约束

| 约束 | 规则 | 检查时机 |
|------|------|---------|
| 命令名称唯一 | 不同命令定义的name必须唯一 | 启动时 |
| 参数名称唯一 | 同一命令的参数name必须唯一 | 启动时 |
| 前置条件有效 | preconditionType必须是已知类型 | 启动时 |
| 步骤顺序连续 | steps的order必须从1开始连续 | 启动时 |

### 10.2 运行时数据约束

| 约束 | 规则 | 检查时机 |
|------|------|---------|
| 命令名存在 | 解析的命令名必须在COMMAND_REGISTRY中 | 命令解析时 |
| 必需参数存在 | required=true的参数必须提供 | 命令解析后 |
| 参数格式正确 | 参数值必须匹配pattern（如有） | 命令解析后 |

### 10.3 状态一致性约束

| 约束 | 规则 | 检查时机 |
|------|------|---------|
| 阶段流转合法 | 只能按顺序流转或回滚 | 阶段命令执行前 |
| 审批状态正确 | 审批前status必须是in_progress | 审批命令执行前 |
| 模块全部完成 | 审批前所有模块status必须是completed | 审批命令执行前 |

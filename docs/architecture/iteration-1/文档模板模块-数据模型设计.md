# 文档模板模块 - 数据模型设计

<!--
章节ID规范说明：
- 格式：{#arch-文档模板-[章节标识]}
- 必须标注ID的章节：Schema定义、类型定义
- 示例：{#arch-文档模板-验证结果} 表示文档模板模块数据模型的验证结果章节
-->

> **项目**: AI超级个体开发助手
> **版本**: v1.0.0
> **迭代**: Iteration 1
> **模块**: 文档模板模块
> **日期**: 2025-12-15

---

## 一、数据模型概述

### 1.1 核心数据结构

文档模板模块的数据模型分为以下几类：

| 类别 | 用途 | 关键类型 |
|------|------|----------|
| **模板相关** | 模板加载与填充 | Template, TemplateVariable |
| **引用相关** ⭐ | 文档引用解析 | DocumentReference, SectionIdInfo |
| **验证相关** ⭐ | 验证结果表示 | ReferenceValidationResult |
| **版本相关** | 模板版本管理 | TemplateVersions |

> ⭐ 标记的是 stage1 必需功能（PRD 4.4）

### 1.2 数据流向

```
                    ┌─────────────────┐
                    │  模板文件(.md)   │
                    └────────┬────────┘
                             ↓ 解析
┌─────────────────────────────────────────────────────┐
│  模板数据结构                                        │
│  ├─ Template (模板元数据)                           │
│  ├─ TemplateVariable[] (变量占位符)                 │
│  └─ TemplateSection[] (章节结构)                    │
└─────────────────────────────────────────────────────┘
                             ↓ 填充
┌─────────────────────────────────────────────────────┐
│  生成文档                                            │
│  ├─ FilledTemplate (填充后模板)                     │
│  └─ 保存到 docs/[阶段]/iteration-X/                 │
└─────────────────────────────────────────────────────┘
                             ↓ 验证
┌─────────────────────────────────────────────────────┐
│  验证数据结构 ⭐                                     │
│  ├─ DocumentReference[] (引用列表)                  │
│  ├─ SectionIdInfo[] (章节ID列表)                    │
│  └─ ReferenceValidationResult (验证结果)            │
└─────────────────────────────────────────────────────┘
```

---

## 二、模板相关类型

### 2.1 模板类型定义

```typescript
/**
 * 模板类型枚举
 */
type TemplateType = 'prd' | 'architecture' | 'testing' | 'deployment';

/**
 * 模板元数据
 */
interface Template {
  /** 模板类型 */
  type: TemplateType;

  /** 模板名称 */
  name: string;

  /** 模板文件路径 */
  filePath: string;

  /** 模板内容 */
  content: string;

  /** 模板版本 */
  version: string;

  /** 变量占位符列表 */
  variables: TemplateVariable[];

  /** 章节结构 */
  sections: TemplateSection[];
}

/**
 * 模板变量
 */
interface TemplateVariable {
  /** 变量名（不含括号） */
  name: string;

  /** 变量占位符（含括号），如 "[项目名称]" */
  placeholder: string;

  /** 数据来源 */
  source: VariableSource;

  /** 是否必填 */
  required: boolean;

  /** 默认值 */
  defaultValue?: string;
}

/**
 * 变量来源
 */
type VariableSource =
  | { type: 'state'; path: string }           // state.json字段
  | { type: 'context'; key: string }          // 上下文推断
  | { type: 'user'; prompt: string };         // 询问用户

/**
 * 模板章节
 */
interface TemplateSection {
  /** 章节级别 (1-6) */
  level: number;

  /** 章节标题 */
  title: string;

  /** 章节ID（如果有） */
  id?: string;

  /** 是否必须 */
  required: boolean;

  /** 子章节 */
  children: TemplateSection[];
}
```

### 2.2 填充后模板

```typescript
/**
 * 填充后的模板
 */
interface FilledTemplate {
  /** 原模板 */
  template: Template;

  /** 填充后的内容 */
  content: string;

  /** 已填充的变量 */
  filledVariables: Record<string, string>;

  /** 未填充的变量（保留占位符） */
  unfilledVariables: string[];

  /** 填充时间 */
  filledAt: string;
}
```

---

## 三、引用相关类型（stage1核心）⭐ {#arch-文档模板-引用类型}

### 3.1 文档引用

```typescript
/**
 * 文档引用结构
 * 对应 PRD 4.4.4 接口定义
 */
interface DocumentReference {
  /** 引用方文件路径 */
  sourceFile: string;

  /** 引用所在行号 */
  sourceLine: number;

  /** 被引用文件路径（已解析为绝对路径） */
  targetFile: string;

  /** 被引用章节ID（可选） */
  targetSection?: string;

  /** 引用文本（链接显示文字） */
  referenceText: string;
}
```

**示例**：

```typescript
// 对于 Markdown 引用：
// [状态管理模块PRD](../../PRD/modules/状态管理模块-PRD.md#prd-状态管理-验收标准)

const reference: DocumentReference = {
  sourceFile: '/docs/architecture/iteration-1/状态管理模块-集成设计.md',
  sourceLine: 42,
  targetFile: '/docs/PRD/modules/状态管理模块-PRD.md',
  targetSection: 'prd-状态管理-验收标准',
  referenceText: '状态管理模块PRD'
};
```

### 3.2 章节ID信息

```typescript
/**
 * 章节ID信息
 * 用于章节ID解析和验证
 */
interface SectionIdInfo {
  /** 所在文件路径 */
  file: string;

  /** 所在行号 */
  lineNumber: number;

  /** 章节级别 (1-6) */
  level: number;

  /** 章节标题 */
  sectionName: string;

  /** 章节ID */
  id: string;
}
```

**示例**：

```typescript
// 对于 Markdown 章节：
// ### 4.1 命令清单 {#prd-命令体系-命令清单}

const sectionId: SectionIdInfo = {
  file: '/docs/PRD/modules/命令体系模块-PRD.md',
  lineNumber: 130,
  level: 3,
  sectionName: '4.1 命令清单',
  id: 'prd-命令体系-命令清单'
};
```

---

## 四、验证相关类型（stage1核心）⭐ {#arch-文档模板-验证结果}

### 4.1 验证结果

```typescript
/**
 * 引用验证结果
 * 对应 PRD 4.4.4 接口定义
 */
interface ReferenceValidationResult {
  /** 有效引用 */
  valid: DocumentReference[];

  /** 文件不存在的引用 */
  brokenFile: DocumentReference[];

  /** 章节ID不存在的引用 */
  brokenSection: DocumentReference[];

  /** 缺少必须章节ID的章节 */
  missingId: SectionInfo[];

  /** 重复的章节ID */
  duplicateId: DuplicateIdInfo[];

  /** 内容不一致的引用 */
  inconsistent: InconsistencyInfo[];
}

/**
 * 缺失ID的章节信息
 * 对应 PRD 4.4.4 SectionInfo
 */
interface SectionInfo {
  /** 文件路径 */
  file: string;

  /** 章节名称 */
  sectionName: string;

  /** 行号 */
  lineNumber: number;

  /** 应该标注的ID */
  requiredId: string;
}

/**
 * 重复ID信息
 * 对应 PRD 4.4.4 DuplicateIdInfo
 */
interface DuplicateIdInfo {
  /** 重复的ID值 */
  id: string;

  /** 出现位置列表 */
  occurrences: {
    file: string;
    lineNumber: number;
    sectionName: string;
  }[];
}

/**
 * 不一致信息
 * 对应 PRD 4.4.4 InconsistencyInfo
 */
interface InconsistencyInfo {
  /** 不一致类型 */
  type: 'command_mismatch' | 'schema_mismatch' | 'acceptance_mismatch';

  /** 源文件 */
  sourceFile: string;

  /** 目标文件 */
  targetFile: string;

  /** 描述 */
  description: string;
}
```

### 4.2 验证规则

```typescript
/**
 * 验证规则定义
 */
interface ValidationRule {
  /** 规则ID */
  id: string;

  /** 规则名称 */
  name: string;

  /** 严重程度 */
  severity: 'error' | 'warning';

  /** 规则描述 */
  description: string;

  /** 是否启用 */
  enabled: boolean;
}

/**
 * PRD 4.4.5 定义的5条规则
 */
const VALIDATION_RULES: ValidationRule[] = [
  {
    id: 'file_exists',
    name: '文件存在性检查',
    severity: 'error',
    description: '检查被引用的文件是否存在',
    enabled: true
  },
  {
    id: 'section_exists',
    name: '章节ID存在性检查',
    severity: 'error',
    description: '检查被引用的章节ID是否存在',
    enabled: true
  },
  {
    id: 'required_id',
    name: '必须章节ID检查',
    severity: 'warning',
    description: '检查必须标注ID的章节是否已标注',
    enabled: true
  },
  {
    id: 'consistency',
    name: '内容一致性检查',
    severity: 'warning',
    description: '检查PRD与架构文档的一致性',
    enabled: true
  },
  {
    id: 'id_uniqueness',
    name: 'ID唯一性检查',
    severity: 'error',
    description: '检查章节ID是否全局唯一',
    enabled: true
  }
];
```

### 4.3 单文档验证结果

```typescript
/**
 * 单文档验证结果
 */
interface DocumentValidationResult {
  /** 文档路径 */
  filePath: string;

  /** 是否通过验证 */
  isValid: boolean;

  /** 错误列表 */
  errors: ValidationError[];

  /** 警告列表 */
  warnings: ValidationWarning[];

  /** 该文档的引用列表 */
  references: DocumentReference[];

  /** 该文档的章节ID列表 */
  sectionIds: SectionIdInfo[];
}

/**
 * 验证错误
 */
interface ValidationError {
  /** 规则ID */
  ruleId: string;

  /** 行号 */
  lineNumber: number;

  /** 错误信息 */
  message: string;

  /** 修复建议 */
  suggestion?: string;
}

/**
 * 验证警告
 */
interface ValidationWarning {
  /** 规则ID */
  ruleId: string;

  /** 行号 */
  lineNumber: number;

  /** 警告信息 */
  message: string;

  /** 修复建议 */
  suggestion?: string;
}
```

---

## 五、版本管理类型

### 5.1 模板版本

```typescript
/**
 * 模板版本信息
 * 存储在 state.json.templateVersions
 */
interface TemplateVersions {
  /** PRD模板版本 */
  PRD: string;

  /** 架构模板版本 */
  architecture: string;

  /** 测试模板版本 */
  testing: string;

  /** 部署模板版本 */
  deployment: string;
}

/**
 * 模板升级检查结果
 */
interface UpgradeCheck {
  /** 是否需要升级 */
  needsUpgrade: boolean;

  /** 需要升级的模板类型 */
  outdatedTemplates: {
    type: TemplateType;
    currentVersion: string;
    latestVersion: string;
  }[];

  /** 迁移建议 */
  migrationSuggestions: string[];
}
```

---

## 六、引用图谱类型

### 6.1 引用图谱

```typescript
/**
 * 文档引用图谱
 * 对应 PRD 4.4.7
 * 存储在 state.json.documentReferences
 */
interface DocumentReferenceGraph {
  /** 文档引用关系 */
  [filePath: string]: {
    /** 被哪些文档引用 */
    referencedBy: string[];

    /** 引用了哪些文档 */
    references: string[];
  };
}

/**
 * 引用图谱验证结果
 */
interface ReferenceGraphValidation {
  /** 最后验证时间 */
  lastValidationAt: string;

  /** 验证状态 */
  validationStatus: 'passed' | 'failed' | 'warning';

  /** 文档总数 */
  totalDocuments: number;

  /** 引用总数 */
  totalReferences: number;

  /** 断链数量 */
  brokenCount: number;

  /** 警告数量 */
  warningCount: number;
}
```

---

## 七、必须章节规则

### 7.1 必须标注ID的章节配置

```typescript
/**
 * 必须章节配置
 * 对应 PRD 4.4.2 的规范
 */
interface RequiredSectionConfig {
  /** 文档类型 */
  documentType: DocumentType;

  /** 必须标注ID的章节 */
  requiredSections: RequiredSection[];
}

/**
 * 必须章节
 */
interface RequiredSection {
  /** 章节名称匹配模式 */
  sectionPattern: string;

  /** 章节分类 */
  category: string;
}

/**
 * 文档类型
 */
type DocumentType = 'prd' | 'architecture' | 'testing' | 'deployment' | 'unknown';

/**
 * 必须章节配置（根据 PRD 4.4.2）
 */
const REQUIRED_SECTION_CONFIG: RequiredSectionConfig[] = [
  {
    documentType: 'prd',
    requiredSections: [
      { sectionPattern: '命令清单', category: '功能清单' },
      { sectionPattern: '功能清单', category: '功能清单' },
      { sectionPattern: '接口清单', category: '功能清单' },
      { sectionPattern: '数据模型', category: '数据模型' },
      { sectionPattern: '验收标准', category: '验收标准' }
    ]
  },
  {
    documentType: 'architecture',
    requiredSections: [
      { sectionPattern: '技术架构', category: '技术架构' },
      { sectionPattern: 'Schema', category: 'Schema定义' },
      { sectionPattern: '接口定义', category: '接口定义' },
      { sectionPattern: '对外接口', category: '接口定义' },
      { sectionPattern: '集成点', category: '集成点' }
    ]
  },
  {
    documentType: 'testing',
    requiredSections: [
      { sectionPattern: '用例清单', category: '用例清单' },
      { sectionPattern: '测试结果', category: '测试结果' }
    ]
  },
  {
    documentType: 'deployment',
    requiredSections: [
      { sectionPattern: '前置条件', category: '前置条件' },
      { sectionPattern: '部署步骤', category: '部署步骤' },
      { sectionPattern: '回滚步骤', category: '回滚步骤' }
    ]
  }
];
```

---

## 八、错误类型

### 8.1 模块错误定义

```typescript
/**
 * 文档模板模块错误基类
 */
abstract class DocumentTemplateError extends Error {
  abstract readonly code: string;
}

/**
 * 模板未找到错误
 */
class TemplateNotFoundError extends DocumentTemplateError {
  readonly code = 'TEMPLATE_NOT_FOUND';

  constructor(templatePath: string) {
    super(`模板文件不存在：${templatePath}`);
  }
}

/**
 * 模板解析错误
 */
class TemplateParseError extends DocumentTemplateError {
  readonly code = 'TEMPLATE_PARSE_ERROR';

  constructor(templatePath: string, lineNumber: number, reason: string) {
    super(`模板解析错误：${templatePath}:${lineNumber} - ${reason}`);
  }
}

/**
 * 变量未填充错误
 */
class VariableNotFilledError extends DocumentTemplateError {
  readonly code = 'VARIABLE_NOT_FILLED';

  constructor(variableNames: string[]) {
    super(`以下变量未填充：${variableNames.join(', ')}`);
  }
}

/**
 * 文档验证错误
 */
class DocumentValidationError extends DocumentTemplateError {
  readonly code = 'DOCUMENT_VALIDATION_ERROR';

  constructor(
    public readonly filePath: string,
    public readonly errors: ValidationError[]
  ) {
    super(`文档验证失败：${filePath}，共${errors.length}个错误`);
  }
}
```

---

## 九、state.json 扩展字段

### 9.1 文档引用图谱字段

根据 PRD 4.4.7，在 state.json 中维护文档引用图谱：

```json
{
  "documentReferences": {
    "docs/PRD/modules/状态管理模块-PRD.md": {
      "referencedBy": [
        "docs/architecture/iteration-1/状态管理模块-数据模型设计.md",
        "docs/architecture/iteration-1/状态管理模块-集成设计.md"
      ],
      "references": [
        "docs/architecture/iteration-1/命令设计.md"
      ]
    },
    "docs/architecture/iteration-1/状态管理模块-数据模型设计.md": {
      "referencedBy": [],
      "references": [
        "docs/PRD/modules/状态管理模块-PRD.md"
      ]
    }
  },
  "lastValidationAt": "2025-12-15T04:00:00Z",
  "validationStatus": "passed"
}
```

---

## 十、类型导出汇总

```typescript
// 模板相关
export type { Template, TemplateVariable, TemplateSection, FilledTemplate };
export type { TemplateType, VariableSource };

// 引用相关（stage1核心）
export type { DocumentReference, SectionIdInfo };

// 验证相关（stage1核心）
export type {
  ReferenceValidationResult,
  SectionInfo,
  DuplicateIdInfo,
  InconsistencyInfo,
  ValidationRule,
  DocumentValidationResult,
  ValidationError,
  ValidationWarning
};

// 版本相关
export type { TemplateVersions, UpgradeCheck };

// 引用图谱
export type { DocumentReferenceGraph, ReferenceGraphValidation };

// 配置
export type { RequiredSectionConfig, RequiredSection, DocumentType };

// 错误
export {
  DocumentTemplateError,
  TemplateNotFoundError,
  TemplateParseError,
  VariableNotFilledError,
  DocumentValidationError
};

// 常量
export { VALIDATION_RULES, REQUIRED_SECTION_CONFIG };
```

---

## 十一、与PRD的映射

| PRD章节 | 对应数据类型 | 说明 |
|---------|-------------|------|
| 4.4.2 章节ID规范 | SectionIdInfo, RequiredSectionConfig | 章节ID解析和必须章节配置 |
| 4.4.3 引用格式规范 | DocumentReference | 引用解析结果 |
| 4.4.4 接口定义 | ReferenceValidationResult | 验证结果接口 |
| 4.4.5 验证规则 | ValidationRule, VALIDATION_RULES | 5条验证规则 |
| 4.4.7 引用图谱 | DocumentReferenceGraph | state.json扩展字段 |

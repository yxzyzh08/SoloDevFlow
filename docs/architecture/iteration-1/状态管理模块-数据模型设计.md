# 状态管理模块 - 数据模型设计

> **项目**: AI超级个体开发助手
> **版本**: v1.0.0
> **迭代**: Iteration 1
> **模块**: 状态管理模块
> **日期**: 2025-12-14

---

## 一、数据模型概述

### 1.1 设计理念

状态管理模块的数据模型遵循以下设计理念：

**理念1：单一数据源(Single Source of Truth)**
- state.json是项目状态的唯一权威来源
- 所有模块从state.json读取状态，不缓存副本
- 避免状态分散导致的不一致

**理念2：分层存储(Tiered Storage)**
- state.json: 当前迭代的活跃数据（< 100KB）
- state_his.json: 历史迭代的归档数据（可增长）
- 通过迁移机制保持state.json轻量

**理念3：完整性约束(Integrity Constraints)**
- 所有状态变更都经过核心流程模型验证
- 7类完整性约束保证数据一致性
- 变更历史可追溯

### 1.2 核心数据结构

| 数据结构 | 职责 | 存储位置 |
|---------|------|---------|
| `State` | 完整项目状态 | state.json |
| `HistoricalState` | 历史迭代归档 | state_his.json |
| `Change` | 变更记录 | state.json.changeHistory |
| `ProgressSummary` | 进度摘要（计算值） | 内存 |

---

## 二、核心类型定义

### 2.1 State - 完整项目状态

```typescript
/**
 * State - 完整项目状态
 * 存储位置: .solodev/state.json
 */
interface State {
  /** Schema版本 */
  schema_version: string;  // "1.0.0"

  /** 项目基本信息 */
  project: ProjectInfo;

  /** 自举信息(仅当前项目需要) */
  bootstrap?: BootstrapInfo;

  /** 当前迭代ID */
  currentIteration: string;  // "iteration-1"

  /** 所有迭代(仅当前活跃迭代) */
  iterations: Record<string, Iteration>;

  /** 模块依赖关系(所有迭代共享) */
  moduleDependencies: ModuleDependencies;

  /** 全局任务 */
  globalTasks: GlobalTasks;

  /** 变更历史(仅当前迭代) */
  changeHistory: Change[];

  /** 设置 */
  settings: Settings;

  /** 元数据 */
  metadata: Metadata;

  /** 模板版本 */
  templateVersions: TemplateVersions;
}
```

### 2.2 ProjectInfo - 项目基本信息

```typescript
/**
 * 项目基本信息
 */
interface ProjectInfo {
  /** 项目名称 */
  name: string;

  /** 项目描述 */
  description: string;

  /** 项目类型 */
  type: 'backend' | 'frontend' | 'fullstack' | 'library' | 'tool';

  /** 创建时间 */
  createdAt: string;  // ISO8601

  /** 更新时间 */
  updatedAt?: string;  // ISO8601
}
```

### 2.3 Iteration - 迭代

```typescript
/**
 * 迭代 - 继承自核心流程模型的Iteration定义
 */
interface Iteration {
  /** 迭代ID */
  id: string;

  /** 版本号 */
  version: string;

  /** 迭代目标 */
  goal?: string;

  /** 状态 */
  status: IterationStatus;

  /** 开始时间 */
  startedAt: string;

  /** 完成时间 */
  completedAt?: string;

  /** 部署时间 */
  deployedAt?: string;

  /** 当前阶段 */
  currentPhase: string;

  /** 各阶段状态 */
  phases: {
    requirements: PhaseState;
    architecture: PhaseState;
    implementation: PhaseState;
    testing: TestingPhaseState;  // 特殊类型，包含子阶段
    deployment: PhaseState;
  };

  /** Git信息 */
  git?: {
    startCommit: string;
    endCommit?: string;
    tag?: string;
  };
}
```

### 2.4 PhaseState - 阶段状态

```typescript
/**
 * 阶段状态 - 继承自核心流程模型
 */
interface PhaseState {
  /** 状态 */
  status: PhaseStatus;

  /** 开始时间 */
  startedAt?: string;

  /** 审批时间 */
  approvedAt?: string;

  /** 审批人 */
  approvedBy?: string;

  /** 完成时间 */
  completedAt?: string;

  /** 模块状态 */
  modules: Record<string, ModuleState>;

  /** 当前处理进度 */
  currentProcess?: CurrentProcess;
}

/**
 * 当前处理进度
 */
interface CurrentProcess {
  /** 当前模块 */
  currentModule: string | null;

  /** 已完成模块 */
  completedModules: string[];

  /** 剩余模块 */
  remainingModules: string[];

  /** 下一步建议 */
  nextAction: string;
}
```

### 2.5 TestingPhaseState - Testing阶段特殊状态

```typescript
/**
 * Testing阶段状态 - 继承自核心流程模型11.1节
 */
interface TestingPhaseState extends PhaseState {
  /** Testing子阶段状态 */
  testPhases: {
    e2e: TestSubPhaseState;
    performance: TestSubPhaseState;
    chaos: TestSubPhaseState;
  };
}

/**
 * Testing子阶段状态
 */
interface TestSubPhaseState {
  /** 状态 */
  status: TestSubPhaseStatus;

  /** 计划审批时间 */
  planApprovedAt?: string;

  /** 计划审批人 */
  planApprovedBy?: string;

  /** 执行时间 */
  executedAt?: string;

  /** 通过时间 */
  passedAt?: string;

  /** 失败时间 */
  failedAt?: string;

  /** 失败原因 */
  failureReason?: string;

  /** 产物 */
  artifacts: TestSubPhaseArtifacts;
}

/**
 * Testing子阶段状态枚举
 */
type TestSubPhaseStatus =
  | 'pending'
  | 'plan_in_progress'
  | 'plan_approved'
  | 'executing'
  | 'passed'
  | 'failed';

/**
 * Testing子阶段产物
 */
interface TestSubPhaseArtifacts {
  /** 测试计划 */
  plan: string;

  /** 测试代码 */
  code?: string;

  /** 测试报告 */
  report?: string;
}
```

### 2.6 ModuleState - 模块状态

```typescript
/**
 * 模块状态 - 继承自核心流程模型，扩展回滚字段
 */
interface ModuleState {
  /** 状态 */
  status: ModuleStatus;

  /** 优先级 */
  priority: 'P0' | 'P1' | 'P2';

  /** 开始时间 */
  startedAt?: string;

  /** 审批时间 */
  approvedAt?: string;

  /** 审批人 */
  approvedBy?: string;

  /** 完成时间 */
  completedAt?: string;

  /** 产物 */
  artifacts: string[];

  /** 审核人 */
  reviewer?: string;

  /** 待解决问题(仅requirements) */
  pendingQuestions?: string[];

  /** 已澄清方面(仅requirements) */
  clarifiedAspects?: string[];

  // ===== 回滚相关字段(核心流程模型11.2节) =====

  /** 之前的审批时间(回滚后保留) */
  previousApprovedAt?: string;

  /** 回滚历史 */
  rollbackHistory?: RollbackHistoryEntry[];
}

/**
 * 模块状态枚举 - 扩展自核心流程模型
 */
type ModuleStatus =
  | 'pending'
  | 'in_progress'
  | 'partially_clarified'
  | 'approved'
  | 'completed'
  | 'rolled_back';  // 新增

/**
 * 回滚历史条目
 */
interface RollbackHistoryEntry {
  /** 回滚时间 */
  rolledBackAt: string;

  /** 回滚原因 */
  reason: string;

  /** 从哪个阶段回滚 */
  fromPhase: string;

  /** 回滚到哪个阶段 */
  toPhase: string;
}
```

### 2.7 ModuleDependencies - 模块依赖关系

```typescript
/**
 * 模块依赖关系 - 继承自核心流程模型
 */
type ModuleDependencies = Record<string, ModuleDependency>;

interface ModuleDependency {
  /** 依赖的模块 */
  dependsOn: string[];

  /** 被依赖的模块 */
  dependedBy: string[];

  /** 是否基础模块 */
  isFoundation?: boolean;

  /** 模块描述 */
  description?: string;

  /** 集成点 */
  integrationPoints?: IntegrationPoint[];
}

interface IntegrationPoint {
  /** 目标模块 */
  targetModule: string;

  /** 接口 */
  interface: string;

  /** 目的 */
  purpose: string;

  /** 数据流 */
  dataFlow: string;

  /** 错误处理 */
  errorHandling: string;

  /** 复杂度 */
  complexity: 'simple' | 'complex';
}
```

### 2.8 GlobalTasks - 全局任务

```typescript
/**
 * 全局任务
 */
interface GlobalTasks {
  /** 待处理任务 */
  pending: Task[];

  /** 进行中任务 */
  in_progress?: Task[];

  /** 已完成任务(仅当前迭代) */
  completed: Task[];
}

/**
 * 任务
 */
interface Task {
  /** 任务ID */
  id: string;

  /** 标题 */
  title: string;

  /** 描述 */
  description?: string;

  /** 优先级 */
  priority: 'P0' | 'P1' | 'P2';

  /** 所属迭代 */
  iteration?: string;

  /** 所属阶段 */
  phase?: string;

  /** 所属模块 */
  module?: string;

  /** 创建时间 */
  createdAt: string;

  /** 完成时间 */
  completedAt?: string;

  /** 解决方案 */
  resolution?: string;
}
```

### 2.9 Change - 变更记录

```typescript
/**
 * 变更记录
 */
interface Change {
  /** 时间戳 */
  timestamp: string;

  /** 变更类型 */
  type: ChangeType;

  /** 描述 */
  description: string;

  /** 变更人 */
  changedBy: 'ai' | 'human';

  /** 详细变更 */
  changes: ChangeDetail[];

  /** 决策(可选) */
  decision?: string;

  /** 附加说明 */
  notes?: string;

  /** 评审反馈(可选) */
  reviewFeedback?: string[];

  /** 产物(可选) */
  artifacts?: string[];
}

/**
 * 变更类型 - 扩展自核心流程模型
 */
type ChangeType =
  | 'init'
  | 'bootstrap'
  | 'phase_transition'
  | 'module_status_change'
  | 'module_completed'
  | 'approval'
  | 'rollback'
  | 'task_completed'
  | 'iteration_completed'
  | 'architecture_supplement'  // 架构补充
  | 'hotfix';

/**
 * 变更详情
 */
interface ChangeDetail {
  /** 字段路径 */
  field: string;

  /** 原值 */
  from: any;

  /** 新值 */
  to: any;
}
```

### 2.10 Settings - 设置

```typescript
/**
 * 设置
 */
interface Settings {
  /** 自动读取历史数据 */
  autoReadHistory: boolean;

  /** 阶段流转需要审批 */
  requireApprovalForPhaseTransition: boolean;

  /** 其他设置(可扩展) */
  [key: string]: any;
}
```

### 2.11 Metadata - 元数据

```typescript
/**
 * 元数据
 */
interface Metadata {
  /** 最后Git提交 */
  lastGitCommit: string;

  /** 最后Git提交信息 */
  lastGitCommitMessage: string;

  /** 最后Git提交时间 */
  lastGitCommitAt: string;

  /** state文件版本 */
  stateFileVersion: number;

  /** 总状态变更次数 */
  totalStateChanges: number;

  /** 最后更新时间 */
  lastUpdatedAt: string;

  /** 最后更新人 */
  lastUpdatedBy: 'ai' | 'human';
}
```

---

## 三、历史数据模型

### 3.1 HistoricalState - 历史状态

```typescript
/**
 * 历史状态
 * 存储位置: .solodev/state_his.json
 */
interface HistoricalState {
  /** Schema版本 */
  schema_version: string;

  /** 已完成的迭代 */
  completedIterations: Record<string, HistoricalIteration>;
}
```

### 3.2 HistoricalIteration - 历史迭代

```typescript
/**
 * 历史迭代 - 完整的已归档迭代
 */
interface HistoricalIteration {
  /** 迭代ID */
  id: string;

  /** 版本号 */
  version: string;

  /** 迭代目标 */
  goal: string;

  /** 状态 */
  status: 'completed';

  /** 开始时间 */
  startedAt: string;

  /** 完成时间 */
  completedAt: string;

  /** 部署时间 */
  deployedAt: string;

  /** Git Tag */
  gitTag: string;

  /** 各阶段状态 */
  phases: {
    requirements: PhaseState;
    architecture: PhaseState;
    implementation: PhaseState;
    testing: TestingPhaseState;
    deployment: PhaseState;
  };

  /** 所有任务 */
  tasks: Task[];

  /** 所有变更 */
  changeHistory: Change[];

  /** 迭代总结 */
  summary: string;

  /** 迭代统计 */
  stats?: IterationStats;
}

/**
 * 迭代统计
 */
interface IterationStats {
  /** 总模块数 */
  totalModules: number;

  /** 总任务数 */
  totalTasks: number;

  /** 回滚次数 */
  rollbackCount: number;

  /** 总耗时(天) */
  durationDays: number;
}
```

---

## 四、数据操作模型

### 4.1 UpdateResult - 更新结果

```typescript
/**
 * 更新结果
 */
interface UpdateResult {
  /** 是否成功 */
  success: boolean;

  /** 错误信息 */
  errors?: string[];

  /** 警告信息 */
  warnings?: string[];
}
```

### 4.2 TransitionResult - 流转结果

```typescript
/**
 * 阶段流转结果
 */
interface TransitionResult extends UpdateResult {
  /** 新阶段 */
  newPhase?: string;
}
```

### 4.3 ApproveResult - 审批结果

```typescript
/**
 * 审批结果
 */
interface ApproveResult extends UpdateResult {
  /** 审批时间 */
  approvedAt?: string;
}
```

### 4.4 RollbackResult - 回滚结果

```typescript
/**
 * 回滚结果
 */
interface RollbackResult extends UpdateResult {
  /** 回滚的模块 */
  rolledBackModule?: string;

  /** 目标阶段 */
  targetPhase?: string;

  /** 受影响的模块 */
  affectedModules?: string[];
}
```

### 4.5 MigrationResult - 迁移结果

```typescript
/**
 * 迁移结果
 */
interface MigrationResult extends UpdateResult {
  /** 迁移的迭代ID */
  migratedIterationId?: string;

  /** 新的当前迭代ID */
  newCurrentIterationId?: string;
}
```

### 4.6 HistoryNeedAnalysis - 历史需求分析

```typescript
/**
 * 历史需求分析结果
 */
interface HistoryNeedAnalysis {
  /** 是否需要历史数据 */
  needHistory: boolean;

  /** 原因 */
  reason: string;

  /** 是否需要用户确认 */
  requireConfirmation: boolean;

  /** 建议读取的迭代 */
  suggestedIterations?: string[];
}
```

### 4.7 ProgressSummary - 进度摘要

```typescript
/**
 * 进度摘要 - 用于会话恢复
 */
interface ProgressSummary {
  /** 当前迭代 */
  currentIteration: string;

  /** 当前阶段 */
  currentPhase: string;

  /** 当前模块(如果有) */
  currentModule: string | null;

  /** 已完成模块数 */
  completedModules: number;

  /** 剩余模块数 */
  remainingModules: number;

  /** 上次操作描述 */
  lastAction: string;

  /** 上次操作时间 */
  lastActionTime: string;

  /** 建议下一步 */
  suggestedNextStep: string;
}
```

### 4.8 FileSizeCheck - 文件大小检查

```typescript
/**
 * 文件大小检查结果
 */
interface FileSizeCheck {
  /** 当前大小(KB) */
  sizeKB: number;

  /** 是否超过限制 */
  isOverLimit: boolean;

  /** 是否接近限制 */
  isWarning: boolean;

  /** 建议 */
  recommendation: string | null;
}
```

---

## 五、状态操作规范

### 5.1 状态读取规范

```typescript
/**
 * 状态读取流程
 */
async function readStateFlow(): Promise<State> {
  // 1. 检查缓存
  if (cache.isValid()) {
    return cache.get();
  }

  // 2. 读取文件
  const content = await fs.readFile('.solodev/state.json', 'utf-8');

  // 3. 解析JSON
  let state: State;
  try {
    state = JSON.parse(content);
  } catch (error) {
    throw new StateFileCorruptedError('Invalid JSON');
  }

  // 4. Schema版本检查
  if (state.schema_version !== CURRENT_SCHEMA_VERSION) {
    state = await migrateSchema(state);
  }

  // 5. 更新缓存
  cache.set(state);

  return state;
}
```

### 5.2 状态写入规范

```typescript
/**
 * 状态写入流程
 */
async function writeStateFlow(
  state: State,
  changeDescription: string,
  changes: ChangeDetail[]
): Promise<void> {
  // 1. 记录变更历史
  state.changeHistory.push({
    timestamp: new Date().toISOString(),
    type: inferChangeType(changes),
    description: changeDescription,
    changedBy: 'ai',
    changes
  });

  // 2. 更新metadata
  state.metadata.stateFileVersion++;
  state.metadata.totalStateChanges++;
  state.metadata.lastUpdatedAt = new Date().toISOString();
  state.metadata.lastUpdatedBy = 'ai';

  // 3. 验证状态完整性
  const validation = coreProcess.validateStateIntegrity(state);
  if (!validation.isValid) {
    throw new StateValidationError(validation.errors);
  }

  // 4. 序列化
  const content = JSON.stringify(state, null, 2);

  // 5. 写入文件
  await fs.writeFile('.solodev/state.json', content, 'utf-8');

  // 6. 更新缓存
  cache.set(state);

  // 7. 检查文件大小
  const sizeCheck = await checkFileSize();
  if (sizeCheck.isWarning) {
    console.warn(sizeCheck.recommendation);
  }
}
```

### 5.3 迁移操作规范

```typescript
/**
 * 迭代迁移流程
 */
async function migrateIterationFlow(iterationId: string): Promise<void> {
  // 1. 验证迁移条件
  const state = await readState();
  const iteration = state.iterations[iterationId];

  if (iteration.status !== 'completed' || !iteration.deployedAt) {
    throw new MigrationConditionError('Iteration not ready for migration');
  }

  // 2. 读取历史文件
  let history: HistoricalState;
  try {
    history = await readHistoryFile();
  } catch {
    history = { schema_version: '1.0.0', completedIterations: {} };
  }

  // 3. 构建历史迭代对象
  const historicalIteration: HistoricalIteration = {
    ...iteration,
    status: 'completed',
    tasks: state.globalTasks.completed.filter(t => t.iteration === iterationId),
    changeHistory: state.changeHistory.filter(c => belongsToIteration(c, iterationId)),
    summary: generateSummary(iteration),
    stats: calculateStats(iteration)
  };

  // 4. 写入历史文件
  history.completedIterations[iterationId] = historicalIteration;
  await writeHistoryFile(history);

  // 5. 清理当前状态
  delete state.iterations[iterationId];
  state.globalTasks.completed = state.globalTasks.completed.filter(
    t => t.iteration !== iterationId
  );
  state.changeHistory = state.changeHistory.filter(
    c => !belongsToIteration(c, iterationId)
  );

  // 6. 设置新的当前迭代
  state.currentIteration = `iteration-${parseInt(iterationId.split('-')[1]) + 1}`;
  state.iterations[state.currentIteration] = createNewIteration(state.currentIteration);

  // 7. 写入当前状态
  await writeState(state);
}
```

---

## 六、错误类型定义

### 6.1 状态管理模块错误

```typescript
/**
 * 状态文件未找到错误
 */
class StateFileNotFoundError extends Error {
  readonly code = 'STATE_FILE_NOT_FOUND';

  constructor(message: string = 'state.json not found') {
    super(message);
    this.name = 'StateFileNotFoundError';
  }
}

/**
 * 状态文件损坏错误
 */
class StateFileCorruptedError extends Error {
  readonly code = 'STATE_FILE_CORRUPTED';

  constructor(message: string = 'state.json is corrupted') {
    super(message);
    this.name = 'StateFileCorruptedError';
  }

  /** 修复建议 */
  getRecoverySuggestions(): string[] {
    return [
      '手动检查JSON格式: https://jsonlint.com/',
      '从Git历史恢复: git checkout HEAD~1 .solodev/state.json',
      '检查常见错误: 缺少逗号、多余逗号、引号不匹配'
    ];
  }
}

/**
 * 状态验证错误
 */
class StateValidationError extends Error {
  readonly code = 'STATE_VALIDATION_ERROR';
  readonly errors: string[];

  constructor(errors: string[]) {
    super(`State validation failed: ${errors.join(', ')}`);
    this.name = 'StateValidationError';
    this.errors = errors;
  }
}

/**
 * 迁移条件错误
 */
class MigrationConditionError extends Error {
  readonly code = 'MIGRATION_CONDITION_ERROR';

  constructor(message: string) {
    super(message);
    this.name = 'MigrationConditionError';
  }
}

/**
 * 历史数据未找到错误
 */
class HistoryNotFoundError extends Error {
  readonly code = 'HISTORY_NOT_FOUND';

  constructor(iterationId: string) {
    super(`Historical iteration "${iterationId}" not found`);
    this.name = 'HistoryNotFoundError';
  }
}
```

---

## 七、数据完整性约束

状态管理模块执行的验证（调用核心流程模型）：

### 7.1 写入前验证

| 约束 | 验证内容 | 调用接口 |
|------|---------|---------|
| 约束1 | currentIteration存在性 | validateStateIntegrity() |
| 约束2 | currentPhase存在性 | validateStateIntegrity() |
| 约束3 | 模块名称一致性 | validateStateIntegrity() |
| 约束4 | 已完成阶段模块状态 | validateStateIntegrity() |
| 约束5 | 阶段顺序一致性 | validateStateIntegrity() |
| 约束6 | 依赖关系DAG | validateDependencies() |
| 约束7 | 依赖关系双向一致 | validateDependencies() |

### 7.2 状态流转验证

| 操作 | 验证内容 | 调用接口 |
|------|---------|---------|
| 阶段流转 | 流转是否合法 | validatePhaseTransition() |
| 模块状态更新 | 状态流转是否合法 | validateModuleTransition() |

---

## 八、缓存模型

### 8.1 缓存结构

```typescript
/**
 * 状态缓存
 */
interface StateCache {
  /** 缓存的状态 */
  state: State | null;

  /** 缓存时间戳 */
  timestamp: number;

  /** 缓存有效期(ms) */
  ttl: number;

  /** 是否有效 */
  isValid(): boolean;

  /** 获取缓存 */
  get(): State;

  /** 设置缓存 */
  set(state: State): void;

  /** 使缓存失效 */
  invalidate(): void;
}
```

### 8.2 缓存实现

```typescript
class StateCacheImpl implements StateCache {
  state: State | null = null;
  timestamp: number = 0;
  ttl: number = 5000;  // 5秒

  isValid(): boolean {
    return this.state !== null && Date.now() - this.timestamp < this.ttl;
  }

  get(): State {
    if (!this.state) {
      throw new Error('Cache is empty');
    }
    return this.state;
  }

  set(state: State): void {
    this.state = state;
    this.timestamp = Date.now();
  }

  invalidate(): void {
    this.state = null;
    this.timestamp = 0;
  }
}
```

---

## 九、数据迁移

### 9.1 Schema版本迁移

```typescript
/**
 * Schema迁移函数类型
 */
type SchemaMigration = (state: any) => any;

/**
 * Schema迁移注册表
 */
const schemaMigrations: Record<string, SchemaMigration> = {
  '1.0.0_to_1.1.0': (state) => {
    // 示例: 添加新字段
    state.iterations[state.currentIteration].phases.testing.testPhases = {
      e2e: { status: 'pending', artifacts: { plan: '' } },
      performance: { status: 'pending', artifacts: { plan: '' } },
      chaos: { status: 'pending', artifacts: { plan: '' } }
    };
    state.schema_version = '1.1.0';
    return state;
  }
};

/**
 * 执行Schema迁移
 */
function migrateSchema(state: any): State {
  const currentVersion = state.schema_version;
  const targetVersion = CURRENT_SCHEMA_VERSION;

  if (currentVersion === targetVersion) {
    return state as State;
  }

  const migrationKey = `${currentVersion}_to_${targetVersion}`;
  const migration = schemaMigrations[migrationKey];

  if (!migration) {
    throw new Error(`No migration path from ${currentVersion} to ${targetVersion}`);
  }

  return migration(state) as State;
}
```

---

## 十、总结

### 10.1 数据模型层次

```
┌─────────────────────────────────────────────────────┐
│                   State (顶层)                       │
│  ───────────────────────────────────────────────── │
│  · project: 项目信息                                │
│  · currentIteration: 当前迭代ID                     │
│  · iterations: 迭代列表                             │
│  · moduleDependencies: 模块依赖                     │
│  · globalTasks: 全局任务                            │
│  · changeHistory: 变更历史                          │
│  · settings: 设置                                   │
│  · metadata: 元数据                                 │
└───────────────────────┬─────────────────────────────┘
                        │
    ┌───────────────────┼───────────────────┐
    ↓                   ↓                   ↓
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ Iteration   │   │ Module      │   │ Change      │
│ 迭代        │   │ Dependencies│   │ History     │
│ · phases    │   │ · dependsOn │   │ · changes   │
│ · status    │   │ · dependedBy│   │ · type      │
└──────┬──────┘   └─────────────┘   └─────────────┘
       │
       ↓
┌─────────────┐
│ PhaseState  │
│ · modules   │
│ · status    │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ ModuleState │
│ · artifacts │
│ · status    │
└─────────────┘
```

### 10.2 核心设计要点

1. **单一数据源**: state.json是唯一权威
2. **分层存储**: 活跃数据与历史数据分离
3. **完整性约束**: 所有变更都经过验证
4. **变更追溯**: changeHistory记录所有变更
5. **可扩展**: Schema版本管理支持演进

# 核心流程模型 - 产品需求文档

> **模块**: 核心流程模型
> **版本**: v1.0
> **迭代**: Iteration 1
> **日期**: 2025-12-14

---

## 一、模块愿景

定义AI超级个体开发助手的**双层迭代模型**、**五阶段流转机制**和**反馈循环系统**，确保从需求到部署的完整闭环。

---

## 二、模块职责

1. **双层迭代模型**：定义迭代层（版本演进）和迭代内层（阶段流转）的结构
2. **五阶段流转**：规范需求分析、架构设计、代码实现、测试验证、部署上线的流程
3. **反馈循环机制**：定义测试失败或架构发现问题时的回滚策略
4. **审批点设置**：明确哪些阶段需要人类审批，哪些自动验证
5. **有条件并行**：定义模块间的依赖关系，控制并行执行

---

## 三、详细功能点

### 3.1 双层迭代模型

#### 迭代层（宏观）

**核心理念**：迭代 = 版本

```
Iteration 1 (v1.0 - MVP)
  ├─ 目标: 用户登录 + 基础订单
  ├─ 模块: [用户模块, 订单模块]
  ├─ 状态: completed → 已部署
  └─ Git Tag: v1.0

Iteration 2 (v1.1 - 功能增强)
  ├─ 目标: 支付集成 + 用户模块增强
  ├─ 变更: 新增[支付模块], 变更[用户模块]
  ├─ 状态: in_progress
  └─ Git Tag: (待完成)
```

**关键规则**：
- 每个迭代对应一个版本号（遵循语义化版本）
- 迭代完成必须部署上线
- 部署后创建Git Tag标记版本
- 已完成迭代迁移到state_his.json归档

#### 迭代内层（微观）

**五阶段流转**：

```
requirements → architecture → implementation → testing → deployment
    ↓              ↓                ↓              ↓           ↓
  审批点         审批点          自动验证        审批点      审批点
```

**反馈循环**：
- **反馈循环A**（架构阶段）：发现需求问题 → 回滚到需求分析
- **反馈循环B**（测试阶段）：测试失败 → 分析根因 → 回滚到对应阶段

### 3.2 五阶段详细定义

#### 阶段1：需求分析（Requirements）

**输入**：
- 人类描述需求（自然语言）
- 模块列表和初步职责

**AI执行**：
- 逐个模块澄清需求（AI提问 → 人类回答）
- 生成全局PRD（产品愿景、整体架构）
- 生成各模块PRD（详细需求、用户故事、验收标准）
- 检测需求冲突（前后矛盾）

**审批点**：
- 人类审批全局PRD + 各模块PRD
- 审批通过：进入架构设计阶段
- 审批拒绝：AI根据反馈重新生成PRD

**产物**：
- docs/PRD/PRD.md（全局PRD）
- docs/PRD/modules/[模块名]-PRD.md（各模块PRD）

#### 阶段2：架构设计（Architecture）

**输入**：
- 审批后的PRD
- 技术约束（如有）

**AI执行**：
- 生成系统架构总览（模块职责、技术架构、部署架构）
- 生成技术选型文档（Markdown+JSON+Git+Claude CLI）
- 生成命令设计文档（命令清单、执行流程、返回值）
- 生成数据模型设计（state.json和state_his.json Schema）
- 推断模块间集成点（integrationPoints）

**审批点**：
- 人类审批架构文档
- 审批通过：AI同步integrationPoints到state.json，进入实现阶段
- 审批拒绝：AI根据反馈重新生成架构文档

**反馈循环A**：
- 如果架构设计时发现需求不清晰 → AI提示需求问题
- AI分析影响范围 → 人类确认 → 回滚到需求分析阶段

**产物**：
- docs/architecture/iteration-X/00-系统架构总览.md
- docs/architecture/iteration-X/01-技术选型.md
- docs/architecture/iteration-X/命令设计.md
- docs/architecture/iteration-X/数据模型设计.md
- docs/architecture/iteration-X/集成-[模块名].md（如有复杂集成）

#### 阶段3：代码实现（Implementation）

**输入**：
- 审批后的架构文档
- state.json的integrationPoints

**AI执行**：
- 按模块依赖顺序实现代码（基础模块优先）
- 自动添加@integration标注（标记外部模块调用）
- 生成单元测试（覆盖率100%）
- 生成集成测试（验证模块间集成点）

**验证点**：
- 单元测试自动验证通过（无需人类审批）
- 单元测试覆盖率达到100%（强制要求）
- 集成测试验证通过

**产物**：
- src/[模块名]/（业务代码）
- src/[模块名]/__tests__/*.unit.test.ts（单元测试）
- src/[模块名]/__tests__/*.integration.test.ts（集成测试）

#### 阶段4：测试验证（Testing）

**输入**：
- PRD的用户故事和验收标准
- 实现完成的代码

**AI执行**：
- 生成E2E测试计划（基于PRD的用户故事）→ 人类审批 → 生成测试代码
- E2E测试通过后，生成性能测试方案 → 人类审批 → 生成测试代码
- 性能测试通过后，生成混沌测试方案 → 人类审批 → 生成测试代码

**审批点**：
- 人类审批E2E测试计划
- 人类审批性能测试方案
- 人类审批混沌测试方案

**反馈循环B**：
- 测试失败 → AI执行分层分析：
  - 第一层：测试用例问题 vs 代码问题
  - 第二层：Bug vs 设计问题
  - 第三层：架构问题 vs 需求问题
- AI生成根因分析报告 → 人类确认
- AI生成待办任务（自上而下：需求 → 架构 → 实现 → 测试）
- 回滚到对应阶段，重新走流程

**产物**：
- docs/testing/iteration-X/E2E测试计划.md
- tests/e2e/*.e2e.test.ts
- docs/testing/iteration-X/性能测试方案.md
- tests/performance/*.perf.test.ts
- docs/testing/iteration-X/混沌测试方案.md
- tests/chaos/*.chaos.test.ts

#### 阶段5：部署（Deployment）

**输入**：
- 所有测试通过的代码
- 架构文档中的部署需求

**AI执行**：
- 生成部署手册（部署步骤、前置条件）
- 生成运维手册（监控、故障处理）
- 生成CI/CD配置（GitHub Actions或其他）

**审批点**：
- 人类审批部署方案
- 审批通过：人工执行部署操作
- 部署成功后：
  - 更新deployedAt时间戳
  - 创建Git Tag（如v1.0）
  - 迁移迭代数据到state_his.json

**产物**：
- docs/deployment/iteration-X/部署手册.md
- docs/deployment/iteration-X/运维手册.md
- .github/workflows/deploy.yml（CI/CD配置）

### 3.3 有条件并行机制

**核心规则**：基础模块必须先完成当前阶段，依赖模块才能进入下一阶段

**示例**：

```
模块依赖关系：
  用户模块（基础模块，无依赖）
    ↓ 被依赖
  订单模块（依赖用户模块）
    ↓ 被依赖
  支付模块（依赖订单模块和用户模块）

并行控制：
  阶段1（需求分析）：
    - 用户模块可以先开始澄清
    - 订单模块可以同时澄清（不依赖用户模块的需求）
    - 支付模块可以同时澄清

  阶段2（架构设计）：
    - 用户模块必须完成架构设计
    - 订单模块才能开始架构设计（需要知道用户模块的接口定义）
    - 支付模块必须等待订单模块和用户模块完成

  阶段3（代码实现）：
    - 用户模块必须完成实现
    - 订单模块才能开始实现（需要调用用户模块的接口）
    - 支付模块必须等待订单模块和用户模块完成
```

**并行判断依据**：
- 读取state.json的moduleDependencies
- 检查依赖模块的当前阶段状态
- 只有依赖模块完成当前阶段，才允许当前模块进入下一阶段

---

## 四、用户故事与验收标准

### 故事1：完整走完五阶段流程

```
作为超级个体开发者，我想完整走完五阶段流程，以便交付一个迭代。

验收标准：
  - [ ] 执行 /start-requirements → AI开始需求澄清
  - [ ] AI逐个模块澄清需求，生成全局PRD + 各模块PRD
  - [ ] 执行 /approve 审批PRD → 进入架构设计阶段
  - [ ] AI自动生成架构文档，等待审批
  - [ ] 执行 /approve 审批架构 → 进入代码实现阶段
  - [ ] AI自动实现代码和单元测试，自动验证通过
  - [ ] 执行 /start-testing → AI生成E2E测试计划，等待审批
  - [ ] 审批通过 → AI生成E2E测试代码，执行测试
  - [ ] E2E通过 → AI生成性能测试方案，等待审批
  - [ ] 审批通过 → AI生成性能测试代码，执行测试
  - [ ] 性能通过 → AI生成混沌测试方案，等待审批
  - [ ] 审批通过 → AI生成混沌测试代码，执行测试
  - [ ] 所有测试通过 → 执行 /start-deployment
  - [ ] AI生成部署文档，等待审批
  - [ ] 审批通过 → 人工部署 → 创建Git Tag
```

### 故事2：测试失败触发反馈循环

```
作为超级个体开发者，我想在测试失败时自动分析根因并回滚，以便修正问题。

验收标准：
  - [ ] E2E测试失败（支付退款流程测试失败）
  - [ ] 执行 /report-issue "退款后订单状态不正确"
  - [ ] AI执行分层分析：
      - 第一层：代码问题（非测试用例问题）
      - 第二层：设计问题（非Bug）
      - 第三层：需求问题（PRD未定义退款后订单状态）
  - [ ] AI生成根因分析报告：
      - 根因：需求未定义退款后订单状态
      - 建议回滚：requirements阶段
      - 受影响模块：支付模块（直接）、订单模块（依赖）
      - 受影响产物：PRD、架构、代码、测试
  - [ ] AI生成待办任务列表：
      - 任务1: 重新澄清支付模块需求（requirements）
      - 任务2: 更新支付模块架构设计（architecture）
      - 任务3: 更新订单模块架构设计（architecture，受依赖影响）
      - 任务4: 重新实现支付模块代码（implementation）
      - 任务5: 重新实现订单模块代码（implementation）
      - 任务6: 重新执行E2E测试（testing）
  - [ ] 执行 /confirm-change 确认变更方案
  - [ ] AI回滚：
      - 支付模块状态 → requirements阶段
      - 订单模块状态 → architecture阶段
      - 待办任务进入 globalTasks.pending
  - [ ] Git commit记录回滚操作
  - [ ] 重新走流程：需求澄清 → 架构设计 → 实现 → 测试
```

### 故事3：架构阶段发现需求问题

```
作为超级个体开发者，我想在架构设计时发现需求问题立即回滚，以便避免错误架构。

验收标准：
  - [ ] 执行 /start-architecture 开始架构设计
  - [ ] AI设计支付模块架构时，发现PRD未定义支付方式（微信/支付宝/其他）
  - [ ] AI主动提示："PRD未定义支付方式，无法设计支付模块架构"
  - [ ] AI建议回滚到需求分析阶段
  - [ ] 等待用户确认
  - [ ] 执行 /confirm-change 确认回滚
  - [ ] AI回滚：
      - 支付模块状态 → requirements阶段
      - 生成待办任务："澄清支付模块的支付方式"
  - [ ] Git commit记录回滚操作
  - [ ] 执行 /clarify-module 支付模块 重新澄清
```

### 故事4：模块依赖控制并行执行

```
作为系统，我需要根据模块依赖关系控制并行执行，以便避免依赖模块未完成导致的错误。

验收标准：
  - [ ] 项目包含3个模块：用户模块、订单模块、支付模块
  - [ ] moduleDependencies定义：
      - 用户模块：无依赖
      - 订单模块：依赖用户模块
      - 支付模块：依赖订单模块和用户模块
  - [ ] 需求分析阶段：3个模块可以同时澄清
  - [ ] 架构设计阶段：
      - 用户模块先完成架构设计
      - 订单模块才能开始架构设计
      - 支付模块必须等待订单模块和用户模块完成
  - [ ] 代码实现阶段：
      - 用户模块先实现
      - 订单模块等待用户模块完成
      - 支付模块等待订单模块和用户模块完成
  - [ ] 如果用户模块架构未完成，订单模块尝试开始架构设计 → AI阻止并提示："订单模块依赖用户模块，请先完成用户模块的架构设计"
```

---

## 五、依赖关系

**依赖模块**：
- 状态管理模块（读取/更新阶段状态、模块状态）
- Git集成模块（每个阶段完成时Git commit）
- 影响分析模块（反馈循环触发影响分析）

**被依赖模块**：
- 所有模块（都遵循五阶段流转）

---

## 六、非功能需求

### 可恢复性

- 任何阶段中断后，下次会话能够恢复到中断点
- state.json记录当前阶段和模块状态
- AI主动提示上次进度

### 可追溯性

- 每次阶段转换都有Git commit记录
- 每次回滚都有changeHistory记录
- 可以通过Git历史回滚到任何阶段

### 一致性

- 所有阶段的流程一致：输入 → AI执行 → 审批/验证 → 产物
- 所有模块都遵循相同的流程

# 文档模板模块 - 产品需求文档

<!--
章节ID规范说明：
- 格式：{#prd-文档模板-[章节标识]}
- 必须标注ID的章节：模板清单、数据模型、引用验证、验收标准
- 示例：{#prd-文档模板-模板清单} 表示文档模板模块PRD的模板清单章节
-->

> **项目**: AI超级个体开发助手
> **版本**: v1.0
> **迭代**: Iteration 1
> **日期**: 2025-12-14
> **模块**: 文档模板模块
> **状态**: 需求已确认

---

## 一、产品愿景

### 1.1 一句话描述

提供结构化文档模板体系，确保所有阶段产出文档的一致性和完整性。

### 1.2 核心定位

| 维度         | 定义                                    |
| ------------ | --------------------------------------- |
| **产品类型** | 文档模板库 + 变量填充引擎               |
| **目标平台** | Markdown文件系统                        |
| **用户定位** | AI助手（自动填充）+ 独立开发者（审阅） |
| **核心价值** | 标准化文档结构，减少AI生成文档的随意性  |

### 1.3 技术定位

- **部署方式**：文件系统（.solodev/templates/目录）
- **集成方式**：AI读取模板 → 填充变量 → 生成文档
- **数据持久化**：模板文件（Markdown）+ 生成文档（Markdown）

---

## 二、目标用户

### 2.1 用户画像

```yaml
名称: AI助手（主要用户）+ 独立开发者（次要用户）

AI助手特征:
  - 需要清晰的文档结构指导
  - 需要变量占位符明确填充内容
  - 需要区分必须章节和可选章节
  - 需要引用式设计避免内容重复

独立开发者特征:
  - 需要快速理解文档结构
  - 需要审阅AI生成的文档是否完整
  - 需要定制化模板（后端、前端、全栈）
  - 需要模板演进时的版本管理

典型场景:
  - AI生成PRD文档时读取PRD模板
  - AI生成架构文档时读取架构模板
  - 用户审阅文档时对照模板检查完整性
  - 模板升级时迁移旧文档

核心诉求:
  - 模板结构清晰、章节划分合理
  - 变量填充规则明确
  - 模板可复用、可扩展
  - 模板变更不影响已生成文档
```

### 2.2 用户痛点

| 痛点          | 描述           | 影响           | 解决方案       |
| ------------- | -------------- | -------------- | -------------- |
| **P1: 文档结构不一致** | AI生成的文档结构每次不同 | 阅读成本高，难以对比 | 提供标准模板，强制AI遵循 |
| **P2: 内容重复冗余** | 同一信息在多个文档重复 | 维护成本高，容易不一致 | 引用式设计（PRD是详细数据源，架构文档引用） |
| **P3: 模板变量混乱** | 不清楚哪些地方需要填充 | AI填充遗漏，文档不完整 | 标准化变量占位符（[变量名]） |
| **P4: 模板缺乏指导** | 模板只有结构，没有说明 | AI不知道如何填充 | 模板中添加注释和示例 |

---

## 三、功能架构

### 3.1 系统架构图

```
模板存储（.solodev/templates/）
  ├─ PRD模板（PRD-backend-template.md）
  ├─ 架构模板（5个）
  ├─ 测试模板（4个）
  └─ 部署模板（4个）
       ↓
AI读取模板
       ↓
变量填充
  ├─ 从state.json读取（项目名、版本号、迭代）
  ├─ 从任务上下文推断（模块名、当前日期）
  └─ 询问用户（无法推断的信息）
       ↓
内容填充
  ├─ 基于PRD填充（用户故事、验收标准）
  ├─ 基于架构填充（命令设计、数据模型）
  └─ 基于通用知识填充（测试场景、部署步骤）
       ↓
生成完整文档
       ↓
保存到目标路径（docs/[类型]/iteration-X/[文档名].md）

完整架构设计详见：docs/architecture/iteration-1/00-系统架构总览.md
```

### 3.2 模块划分

| 模块名        | 职责               | 实现方式           |
| ------------- | ------------------ | ------------------ |
| **模板存储模块** | 管理所有文档模板 | .solodev/templates/目录 |
| **变量解析模块** | 识别模板中的变量占位符 | 正则表达式匹配 [变量名] |
| **变量填充模块** | 从多个数据源填充变量 | state.json + 上下文推断 |
| **内容生成模块** | 基于模板和数据生成文档内容 | AI推理 + 模板合并 |
| **模板版本管理** | 管理模板版本，支持迁移 | state.json.templateVersions |
| **文档引用验证** | 验证文档间引用关系的有效性 | 程序自动扫描 + 规则验证 |

---

## 四、核心功能设计

### 4.1 模板清单 {#prd-文档模板-模板清单}

**已实现的14个模板**

| 模板类型       | 模板文件                          | 用途                   |
| -------------- | --------------------------------- | ---------------------- |
| **PRD模板**    | PRD-backend-template.md           | 生成需求文档           |
| **架构模板**   | 00-系统架构总览.md                | 生成系统架构总览       |
| **架构模板**   | 01-技术选型.md                    | 生成技术选型文档       |
| **架构模板**   | 命令设计.md                       | 生成命令设计文档       |
| **架构模板**   | 数据模型设计.md                   | 生成数据模型文档       |
| **架构模板**   | 集成-模板.md                      | 生成模块集成设计文档   |
| **测试模板**   | 00-测试总览-模板.md               | 生成测试总览文档       |
| **测试模板**   | E2E测试计划-模板.md               | 生成E2E测试计划        |
| **测试模板**   | 性能测试方案-模板.md              | 生成性能测试方案       |
| **测试模板**   | 混沌测试方案-模板.md              | 生成混沌测试方案       |
| **部署模板**   | 00-部署总览-模板.md               | 生成部署总览文档       |
| **部署模板**   | 部署手册-模板.md                  | 生成部署手册           |
| **部署模板**   | 运维手册-模板.md                  | 生成运维手册           |
| **部署模板**   | CICD配置说明-模板.md              | 生成CI/CD配置说明      |

**完整模板详见**：.solodev/templates/目录

### 4.2 数据模型 {#prd-文档模板-数据模型}

#### 核心数据结构（概览）

**state.json - templateVersions字段** - 模板版本管理

```json
{
  "templateVersions": {
    "PRD": "1.0.0",
    "architecture": "1.0.0",
    "testing": "1.0.0",
    "deployment": "1.0.0"
  }
}
```

**模板变量系统** - 变量占位符定义

```markdown
> **项目**: [项目名称]
> **版本**: [版本号]
> **迭代**: Iteration X
> **日期**: YYYY-MM-DD
> **模块**: [模块名称]
```

**变量来源映射表**

| 变量占位符         | 数据来源                              | 示例值                     |
| ------------------ | ------------------------------------- | -------------------------- |
| `[项目名称]`       | state.json → project.name             | AI超级个体开发助手         |
| `[项目描述]`       | state.json → project.description      | 一个完整的人机协作开发流程 |
| `[版本号]`         | state.json → iterations[current].version | v1.0                    |
| `[迭代]`           | state.json → currentIteration         | Iteration 1                |
| `YYYY-MM-DD`       | 当前日期（生成文档时）                | 2025-12-14                 |
| `[模块名称]`       | 当前处理的模块名称（任务上下文）      | 文档模板模块               |

**关键字段说明**：

| 字段名      | 类型     | 说明                   | 必填 |
| ----------- | -------- | ---------------------- | ---- |
| `templateVersions` | object | 各类型模板的版本号 | 是 |
| `[变量名]` | string | 模板中的变量占位符 | 视模板而定 |

**完整数据模型详见**：docs/architecture/iteration-1/03-数据模型设计.md

### 4.3 核心工作流

**工作流1：AI生成PRD文档**

```
用户执行：/start-requirements
  ↓
【步骤1】AI读取PRD模板
  读取：.solodev/templates/PRD-backend-template.md
  ↓
【步骤2】AI填充变量
  - [项目名称] ← state.json.project.name = "AI超级个体开发助手"
  - [版本号] ← state.json.iterations[current].version = "v1.0"
  - [迭代] ← state.json.currentIteration = "Iteration 1"
  - YYYY-MM-DD ← 当前日期 = "2025-12-14"
  ↓
【步骤3】AI逐模块澄清需求，填充模板内容
  - 一、产品愿景 → 基于用户输入填充
  - 二、目标用户 → 基于用户画像填充
  - 三、功能架构 → 基于模块划分填充
  - 四、核心功能设计 → 基于命令/接口清单填充
  - 五、用户故事与验收标准 → 基于澄清结果填充
  ↓
【步骤4】AI生成完整PRD文档
  保存到：docs/PRD/PRD.md
  ↓
【步骤5】AI提交给用户审批

完整工作流设计详见：CLAUDE.md（第六节 - 文档模板使用指南）
```

**工作流2：AI生成架构文档**

```
用户执行：/start-architecture
  ↓
【步骤1】AI决定使用哪些架构模板
  - 简单模块 → 仅在 00-系统架构总览.md 中描述
  - 复杂模块 → 创建独立的 模块-[模块名]-架构.md
  - 命令体系 → 使用 命令设计.md 模板
  - 数据模型 → 使用 数据模型设计.md 模板
  - 复杂集成 → 使用 集成-模板.md
  ↓
【步骤2】AI读取对应模板
  ↓
【步骤3】AI填充变量
  - [项目名称]、[版本号]、[迭代] 等通用变量
  - [命令名称]、[接口名称] 等特定变量
  ↓
【步骤4】AI填充内容
  - 基于PRD的功能需求
  - 基于技术选型决策
  - 基于模块划分
  ↓
【步骤5】AI生成完整架构文档
  保存到：docs/architecture/iteration-1/[文档名].md
  ↓
【步骤6】AI提交给用户审批
```

**工作流3：AI生成测试文档**

```
用户执行：/start-testing
  ↓
【步骤1】AI读取测试模板
  - 00-测试总览-模板.md
  - E2E测试计划-模板.md
  - 性能测试方案-模板.md
  - 混沌测试方案-模板.md
  ↓
【步骤2】AI填充变量和内容
  - E2E测试 → 基于PRD的验收标准生成测试场景
  - 性能测试 → 基于PRD的性能要求生成测试指标
  - 混沌测试 → 基于通用测试经验库生成测试场景
  ↓
【步骤3】AI生成测试文档
  保存到：docs/testing/iteration-1/[文档名].md
  ↓
【步骤4】AI逐个提交人工审批（3次审批点）
  审批1：E2E测试计划
  审批2：性能测试方案
  审批3：混沌测试方案
```

### 4.4 文档引用验证（Document Reference Validation） {#prd-文档模板-引用验证}

> **定位**：这是一个**产品能力**，由代码实现，确保文档间引用关系的有效性和一致性。

#### 4.4.1 功能定义

| 维度 | 说明 |
|------|------|
| **性质** | 产品能力（代码实现） |
| **实现方式** | 程序自动扫描和验证 |
| **执行时机** | 每次文档生成/更新后自动执行 |
| **归属模块** | 文档模板模块 |

**核心目标**：自动验证文档间的引用关系，发现断链、错误引用、章节缺失等问题。

#### 4.4.2 章节ID规范

**规范目的**：为关键章节分配唯一ID，便于程序化识别和引用验证。

**设计理念**：

| 原则 | 说明 |
|------|------|
| **选择性标注** | 只标注可能被其他文档引用的关键章节，避免ID泛滥 |
| **减少维护负担** | 不需要被引用的章节（如"产品愿景"、"目标用户"）不需要ID |
| **按需标注** | 新增跨文档引用时，按需为目标章节添加ID |

**ID格式**：`{文档类型}-{模块名}-{章节名称}`

> **重要**：统一使用**章节名称**而非章节编号作为ID标识符。原因：
> - 编号容易因章节调整而变化（如插入新章节导致编号后移）
> - 名称更具语义，可读性更好
> - 名称变更频率通常低于编号变更

| 文档类型 | 前缀 | 示例 |
|----------|------|------|
| PRD（总） | `prd-project` | `prd-project-模块划分` |
| PRD（模块） | `prd-{模块名}` | `prd-状态管理-功能清单` |
| 架构文档 | `arch-{模块名}` | `arch-状态管理-数据模型` |
| 测试文档 | `test-{测试类型}` | `test-E2E-用例清单` |
| 部署文档 | `deploy-{文档名}` | `deploy-手册-前置条件` |

**章节ID标注方式**（在Markdown中）：

```markdown
### 4.1 命令清单 {#prd-命令体系-命令清单}

本章节描述所有命令的概览...

**详细设计**：参见 [架构文档-命令设计](../architecture/iteration-1/命令设计.md#arch-命令体系-命令清单)
```

**必须标注ID的章节（统一规范）**：

| 文档类型 | 必须标注的章节 | ID示例 |
|----------|----------------|--------|
| **PRD（总）** | 模块划分、核心机制、用户故事 | `{#prd-project-模块划分}` |
| **PRD（模块）** | 功能点清单/命令清单、数据模型、验收标准 | `{#prd-状态管理-功能清单}`、`{#prd-命令体系-命令清单}` |
| **架构-系统总览** | 技术架构、部署架构、模块职责 | `{#arch-状态管理-技术架构}` |
| **架构-数据模型** | Schema定义、类型定义 | `{#arch-状态管理-Schema定义}` |
| **架构-集成设计** | 接口定义、集成点 | `{#arch-状态管理-接口定义}` |
| **测试-E2E** | 用例清单、测试结果 | `{#test-E2E-用例清单}` |
| **测试-性能** | 测试指标、测试结果 | `{#test-性能-测试指标}` |
| **部署-手册** | 前置条件、部署步骤、回滚步骤 | `{#deploy-手册-前置条件}` |

**中文锚点处理**：

ID支持中文（可读性优先），但需要注意以下处理规则：

| 规则 | 说明 | 示例 |
|------|------|------|
| **保留中文** | 中文字符直接使用 | `prd-状态管理-功能清单` |
| **空格转连字符** | 章节名称中的空格转为 `-` | `用户 故事` → `用户-故事` |
| **去除特殊字符** | 移除 `()[]{}` 等特殊字符 | `功能点(清单)` → `功能点清单` |
| **URL编码** | 跨平台引用时自动URL编码 | `#prd-状态管理-功能清单` → `#prd-%E7%8A%B6%E6%80%81...` |

**规范化函数**（架构阶段实现）：

```typescript
function normalizeAnchor(id: string): string {
  return id
    .replace(/\s+/g, '-')                    // 空格转连字符
    .replace(/[()[\]{}]/g, '')               // 去除括号
    .replace(/[^\w\u4e00-\u9fa5-]/g, '');    // 只保留字母数字中文连字符
}
```

**各PRD文档的章节ID注释更新要求**：

每个PRD文档开头的HTML注释应保持统一格式：

```markdown
<!--
章节ID规范说明：
- 格式：{#prd-{模块名}-{章节名称}}
- 必须标注ID的章节：功能点清单/命令清单、数据模型、验收标准
- 用于跨文档引用和程序化验证
- 注意：使用章节名称而非编号作为ID标识符
-->
```

> **注意**：各模块PRD文档开头的注释中，"必须标注ID的章节"应统一为上述三类，不再使用各自定义的说法。

#### 4.4.3 引用格式规范

**标准引用格式**：

```markdown
<!-- 引用文件 -->
参见 [文档名](相对路径)

<!-- 引用文件+章节 -->
参见 [文档名-章节名](相对路径#章节ID)

<!-- 引用验收标准 -->
验收标准参见 [PRD-验收标准](../../PRD/modules/状态管理模块-PRD.md#prd-状态管理-验收标准)
```

**引用类型**：

| 引用类型 | 格式 | 示例 |
|----------|------|------|
| **文件引用** | `[名称](路径)` | `[状态管理模块PRD](../PRD/modules/状态管理模块-PRD.md)` |
| **章节引用** | `[名称](路径#ID)` | `[数据模型](./数据模型设计.md#arch-状态管理-schema)` |
| **表格引用** | `详见 路径` | `详见 docs/architecture/iteration-1/命令设计.md` |

#### 4.4.4 接口定义

```typescript
// 文档引用结构
interface DocumentReference {
  sourceFile: string;        // 引用方文件路径
  sourceLine: number;        // 引用所在行号
  targetFile: string;        // 被引用文件路径
  targetSection?: string;    // 被引用章节ID（可选）
  referenceText: string;     // 引用文本
}

// 验证结果
interface ReferenceValidationResult {
  valid: DocumentReference[];           // 有效引用
  brokenFile: DocumentReference[];      // 文件不存在
  brokenSection: DocumentReference[];   // 章节ID不存在
  missingId: SectionInfo[];             // 缺少必须的章节ID
  duplicateId: DuplicateIdInfo[];       // 重复的章节ID
  inconsistent: InconsistencyInfo[];    // 内容不一致（如命令清单与命令设计不匹配）
}

// 重复ID信息
interface DuplicateIdInfo {
  id: string;                           // 重复的ID值
  occurrences: {                        // 出现位置列表
    file: string;
    lineNumber: number;
    sectionName: string;
  }[];
}

// 章节信息
interface SectionInfo {
  file: string;
  sectionName: string;
  lineNumber: number;
  requiredId: string;        // 应该标注的ID
}

// 不一致信息
interface InconsistencyInfo {
  type: 'command_mismatch' | 'schema_mismatch' | 'acceptance_mismatch';
  sourceFile: string;
  targetFile: string;
  description: string;
}

// 验证接口
validateDocumentReferences(): Promise<ReferenceValidationResult>

// 扫描所有引用
scanAllReferences(): Promise<DocumentReference[]>

// 检查章节ID覆盖
checkSectionIdCoverage(): Promise<SectionInfo[]>
```

#### 4.4.5 验证规则

**规则1：文件存在性检查**
```
对于每个文档引用：
  IF 被引用文件不存在 THEN 报告 brokenFile 错误
```

**规则2：章节ID存在性检查**
```
对于每个章节引用：
  IF 被引用文件存在 BUT 章节ID不存在 THEN 报告 brokenSection 错误
```

**规则3：必须章节ID检查**
```
对于每个已生成的文档：
  IF 必须标注ID的章节 未标注ID THEN 报告 missingId 警告
```

**规则4：内容一致性检查**
```
PRD命令清单 vs 架构命令设计：
  IF 命令数量不匹配 OR 命令名称不匹配 THEN 报告 command_mismatch

PRD数据模型概览 vs 架构数据模型Schema：
  IF 字段数量不匹配 OR 字段名称不匹配 THEN 报告 schema_mismatch

PRD验收标准 vs E2E测试用例：
  IF 验收条目未被测试覆盖 THEN 报告 acceptance_mismatch
```

**规则5：ID唯一性检查**
```
扫描所有文档的章节ID：
  收集所有 {#xxx} 格式的章节ID
  IF 存在重复ID THEN 报告 duplicateId 错误
    - 列出重复的ID值
    - 列出每个重复ID的所有出现位置（文件、行号、章节名）
```

**验证规则汇总**：

| 规则 | 检查内容 | 错误类型 | 严重程度 |
|------|----------|----------|----------|
| 规则1 | 文件存在性 | brokenFile | 错误（阻断） |
| 规则2 | 章节ID存在性 | brokenSection | 错误（阻断） |
| 规则3 | 必须章节ID | missingId | 警告 |
| 规则4 | 内容一致性 | inconsistent | 警告 |
| 规则5 | ID唯一性 | duplicateId | 错误（阻断） |

#### 4.4.6 执行时机

| 时机 | 触发条件 | 验证范围 |
|------|----------|----------|
| **文档生成后** | AI完成文档生成 | 新生成的文档 |
| **文档更新后** | 用户或AI修改文档 | 被修改的文档及其引用方 |
| **阶段启动前** | 执行 `/start-*` 命令 | 该阶段依赖的所有前置文档 |
| **手动触发** | 执行 `/validate-docs` 命令 | 所有文档 |

**验证流程**：

```
文档生成/更新完成
        ↓
自动执行 validateDocumentReferences()
        ↓
┌─ 验证通过 → 继续流程
│
└─ 验证失败 → 分类处理：
   ├─ brokenFile → 错误：阻止提交，要求修复
   ├─ brokenSection → 错误：阻止提交，要求修复
   ├─ missingId → 警告：允许提交，提示补充
   └─ inconsistent → 警告：允许提交，提示检查
```

#### 4.4.7 文档引用图谱

**自动维护的引用关系**（存储在 state.json）：

```json
{
  "documentReferences": {
    "docs/PRD/modules/状态管理模块-PRD.md": {
      "referencedBy": [
        "docs/architecture/iteration-1/状态管理模块-数据模型设计.md",
        "docs/architecture/iteration-1/状态管理模块-集成设计.md"
      ],
      "references": [
        "docs/architecture/iteration-1/命令设计.md"
      ]
    }
  },
  "lastValidationAt": "2025-12-14T20:00:00Z",
  "validationStatus": "passed"
}
```

---

## 五、用户故事与验收标准 {#prd-文档模板-验收标准}

### 5.1 用户故事清单

#### 用户视角（面向AI助手）

**故事 1：AI读取PRD模板生成文档**
```
作为AI助手，我想读取PRD模板并填充项目信息，以便生成结构一致的需求文档。

验收标准：
  - [ ] AI能够读取 .solodev/templates/PRD-backend-template.md
  - [ ] AI识别模板中的变量占位符（[项目名称]、[版本号] 等）
  - [ ] AI从state.json读取变量值并填充
  - [ ] AI生成的PRD文档包含所有必须章节（一~五）
  - [ ] AI根据项目需要决定是否包含可选章节（六~八）
```

**故事 2：AI填充命令/接口清单**
```
作为AI助手，我想基于澄清的需求生成命令/接口清单，以便在PRD中提供简洁的功能列表。

验收标准：
  - [ ] AI生成的命令清单采用引用式（一句话描述 + 引用架构文档）
  - [ ] AI不在PRD中详细设计命令执行流程（留给架构文档）
  - [ ] 命令清单包含：命令名、描述、详细设计文档路径
  - [ ] 清单格式为Markdown表格
```

**故事 3：AI生成数据模型概览**
```
作为AI助手，我想在PRD中包含数据模型的核心结构，以便用户理解数据设计，但避免过度详细。

验收标准：
  - [ ] AI在PRD中包含核心数据结构（JSON示例）
  - [ ] AI包含关键字段说明表格（字段名、类型、说明、必填）
  - [ ] AI引用架构文档中的详细Schema（避免重复）
  - [ ] 数据模型概览不超过PRD的1/5篇幅
```

**故事 4：AI生成用户故事与验收标准**
```
作为AI助手，我想基于澄清结果生成用户故事和验收标准，以便在Testing阶段生成测试用例。

验收标准：
  - [ ] AI生成的用户故事包含用户视角和系统视角
  - [ ] 每个用户故事包含验收标准清单（checkbox格式）
  - [ ] 验收标准具体、可测试、可验证
  - [ ] E2E测试可直接引用PRD中的验收标准
```

**故事 5：AI生成架构文档（命令设计）**
```
作为AI助手，我想基于命令设计模板生成详细的命令执行流程，以便指导Implementation阶段的代码实现。

验收标准：
  - [ ] AI读取 .solodev/templates/architecture/命令设计.md 模板
  - [ ] AI填充每个命令的执行流程（步骤1、步骤2...）
  - [ ] AI填充命令的返回值、错误处理、异常情况
  - [ ] AI生成的文档保存到 docs/architecture/iteration-1/02-命令设计.md
```

**故事 6：AI生成测试文档（E2E测试计划）**
```
作为AI助手，我想基于E2E测试计划模板生成测试场景，以便覆盖所有用户故事。

验收标准：
  - [ ] AI读取 .solodev/templates/testing/E2E测试计划-模板.md 模板
  - [ ] AI从PRD中提取用户故事和验收标准
  - [ ] AI为每个用户故事生成对应的E2E测试场景
  - [ ] 测试场景包含：测试步骤、断言点、预期结果
  - [ ] AI生成的文档提交人工审批
```

**故事 7：AI生成部署文档（部署手册）**
```
作为AI助手，我想基于部署手册模板生成详细的部署步骤，以便用户能够成功部署系统。

验收标准：
  - [ ] AI读取 .solodev/templates/deployment/部署手册-模板.md 模板
  - [ ] AI基于架构设计（技术栈、依赖服务）填充部署配置
  - [ ] AI生成部署步骤（前置条件、部署命令、验证步骤）
  - [ ] AI包含多环境配置（开发、测试、生产）
```

#### 用户视角（面向独立开发者）

**故事 8：审阅AI生成的文档完整性**
```
作为独立开发者，我想快速检查AI生成的文档是否包含所有必须章节，以便确认文档完整性。

验收标准：
  - [ ] 对照模板结构，检查AI生成的文档是否包含所有必须章节
  - [ ] 检查是否所有变量占位符都已填充（无 [变量名] 残留）
  - [ ] 检查引用式设计是否正确（如命令清单引用架构文档）
  - [ ] 如发现遗漏，要求AI补充
```

**故事 9：定制化模板（后端项目）**
```
作为独立开发者，我想使用后端项目专用的PRD模板，以便生成的文档符合后端项目特点。

验收标准：
  - [ ] 模板包含后端特有内容（技术定位、数据模型、边界条件处理）
  - [ ] 模板包含命令/接口清单（CLI工具或API服务）
  - [ ] 模板包含非功能需求（性能、可靠性、安全性）
  - [ ] AI根据项目类型自动选择对应模板
```

**故事 10：模板版本升级**
```
作为独立开发者，我想在模板升级时，系统能够提供迁移指导，以便已生成的文档也能受益于新模板。

验收标准：
  - [ ] state.json记录当前使用的模板版本（templateVersions）
  - [ ] 模板升级时，系统提示"模板已升级到v2.0，是否迁移已生成文档？"
  - [ ] 提供迁移脚本或手动迁移指南
  - [ ] 旧版本生成的文档保持不变（兼容性）
```

#### 系统视角（面向功能模块）

**故事 11：变量填充优先级机制**
```
作为系统，我需要按优先级从多个数据源填充变量，以便避免不必要的用户询问。

验收标准：
  - [ ] 优先级1：从state.json读取固定信息（项目名、版本号、迭代）
  - [ ] 优先级2：从任务上下文推断（模块名、当前日期）
  - [ ] 优先级3：询问用户（仅当无法推断时）
  - [ ] AI避免询问已在state.json中存在的信息
```

**故事 12：模板自包含原则**
```
作为系统，我需要每个模板独立包含所有必要信息，以便模板可以独立使用。

验收标准：
  - [ ] 每个模板包含完整的章节结构
  - [ ] 每个模板包含变量占位符说明
  - [ ] 每个模板包含注释和示例
  - [ ] 模板之间可以引用，但不强依赖（如PRD引用架构文档）
```

**故事 13：引用式设计验证**
```
作为系统，我需要验证引用式设计的一致性，以便避免PRD和架构文档不一致。

验收标准：
  - [ ] PRD中的命令清单与架构文档中的命令设计一致
  - [ ] PRD中的数据模型概览与架构文档中的详细Schema一致
  - [ ] 验收标准与E2E测试场景一致
  - [ ] 发现不一致时警告用户
```

**故事 14：文档引用有效性验证**
```
作为系统，我需要自动验证文档间的引用关系，以便及时发现断链和错误引用。

验收标准：
  - [ ] 每次文档生成/更新后自动执行引用验证
  - [ ] 检测并报告文件引用错误（被引用文件不存在）
  - [ ] 检测并报告章节引用错误（章节ID不存在）
  - [ ] 验证结果分类处理：文件/章节错误阻止提交，ID缺失/不一致提示警告
  - [ ] 支持手动触发全量验证（/validate-docs命令）
```

**故事 15：章节ID自动检查**
```
作为系统，我需要确保关键章节都有唯一ID，以便支持精确的跨文档引用。

验收标准：
  - [ ] 关键章节必须标注ID，格式：{文档类型}-{模块名}-{章节编号}
  - [ ] PRD文档必须标注ID的章节：命令/接口清单、数据模型概览、验收标准
  - [ ] 架构文档必须标注ID的章节：命令设计、数据模型Schema、接口定义、集成点
  - [ ] 测试文档必须标注ID的章节：测试用例清单、验收标准对照
  - [ ] 检测到缺失ID时发出警告，允许提交但提示补充
```

**故事 16：文档引用图谱维护**
```
作为系统，我需要维护文档间的引用关系图谱，以便支持影响分析和依赖追踪。

验收标准：
  - [ ] 在state.json中自动维护documentReferences字段
  - [ ] 记录每个文档的引用方（referencedBy）和被引用（references）
  - [ ] 阶段启动前（/start-*命令）验证前置文档的引用有效性
  - [ ] 支持查询某文档的所有依赖方，用于变更影响分析
```

### 5.2 边界条件与异常处理

| 场景                 | 期望行为               | 错误处理               |
| -------------------- | ---------------------- | ---------------------- |
| **模板文件缺失**     | 拒绝生成文档，提示检查模板 | 错误码404，提示"模板文件不存在：[路径]" |
| **变量无法推断**     | 询问用户提供变量值 | 提示"请提供[变量名]的值" |
| **模板格式错误**     | 拒绝解析，提示检查格式 | 错误码400，提示"模板格式错误：[行号]" |
| **变量填充遗漏**     | 生成文档但保留占位符，警告用户 | 警告"检测到未填充变量：[变量名]" |
| **引用路径错误**     | 警告用户检查引用路径 | 警告"引用的文档不存在：[路径]" |

---

## 六、非功能需求

### 6.1 性能要求

| 指标             | 要求                   | 备注               |
| ---------------- | ---------------------- | ------------------ |
| **模板读取时间** | < 100ms                | 单个模板文件       |
| **变量填充时间** | < 200ms                | 解析和填充所有变量 |
| **文档生成时间** | < 10秒                 | 包括AI推理时间     |

### 6.2 可靠性要求

- **容错性**：模板文件损坏时降级到默认模板
- **数据一致性**：变量值从state.json读取，保证一致性
- **可恢复性**：文档生成失败时不影响state.json

### 6.3 可维护性要求

- **模板版本管理**：state.json.templateVersions记录模板版本
- **模板迁移支持**：提供迁移脚本或指南
- **模板注释**：每个模板包含使用说明和示例

### 6.4 可扩展性要求

- **支持新模板类型**：可添加前端模板、全栈模板
- **支持模板继承**：v2.0引入公共模板片段（如文档头部、审批区）
- **支持多语言模板**：v2.0支持英文模板

---

## 七、技术约束与依赖

### 7.1 技术栈要求

- **模板格式**：Markdown（.md文件）
- **变量语法**：中括号风格（[变量名]）
- **数据源**：state.json（JSON格式）
- **文件系统**：.solodev/templates/目录

### 7.2 兼容性要求

- **Markdown渲染器**：兼容GitHub Markdown、VSCode Markdown Preview
- **文件路径**：支持Windows/macOS/Linux路径格式
- **模板编码**：UTF-8编码

### 7.3 依赖关系

| 依赖模块       | 依赖原因                     | 集成方式           |
| -------------- | ---------------------------- | ------------------ |
| **状态管理模块** | 读取state.json填充变量 | 直接读取state.json |
| **核心流程模型** | 理解阶段划分和文档类型 | 概念依赖 |
| **命令体系模块** | 各阶段命令触发文档生成 | 命令调用 |

**完整依赖关系详见**：docs/architecture/iteration-1/04-模块集成设计.md

---

## 八、迭代规划

### 8.1 Iteration 1 (MVP)

- **目标**：实现14个核心模板，支持变量填充和内容生成
- **功能范围**：
  - 1个PRD模板（后端项目）
  - 5个架构模板
  - 4个测试模板
  - 4个部署模板
  - 变量填充机制（优先级：state.json → 上下文 → 用户输入）
- **验收标准**：
  - 所有模板可正常使用
  - 变量填充准确率100%
  - 生成的文档结构完整

### 8.2 Iteration 2（未来增强）

- **目标**：增加前端/全栈模板，引入模板继承机制
- **功能范围**：
  - 前端项目PRD模板
  - 全栈项目PRD模板
  - 公共模板片段（document-header.md、approval-section.md）
  - 模板继承和复用机制
  - 多语言模板支持（英文）
- **验收标准**：
  - 前端/全栈模板可正常使用
  - 模板继承机制生效
  - 支持中英文模板切换

---

**文档版本历史**

| 版本  | 日期       | 修改内容               | 修改人 |
| ----- | ---------- | ---------------------- | ------ |
| v1.0  | 2025-12-14 | 初始版本，需求确认完成 | Claude AI |
